/**
 * Diff Match and Patch
 *
 * Copyright 2006 Google Inc.
 * http://code.google.com/p/google-diff-match-patch/
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function diff_match_patch(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32}!function(){var e=!1,t=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(s){function i(){!e&&this.init&&this.init.apply(this,arguments)}var n=this.prototype;e=!0;var o=new this;e=!1;for(var r in s)o[r]="function"==typeof s[r]&&"function"==typeof n[r]&&t.test(s[r])?function(e,t){return function(){var s=this._super;this._super=n[e];var i=t.apply(this,arguments);return this._super=s,i}}(r,s[r]):s[r];return i.prototype=o,i.prototype.constructor=i,i.extend=arguments.callee,i}}();var Love={_saveLoveToDBFunc:null,THROTTLE_DELAY:500,init:function(){_.extend(this,AJAXUtil),this.user=window.__user,this._bindToDOM(),this._createSaveLoveToDBFunc()},_createSaveLoveToDBFunc:function(){this._saveLoveToDBFunc=_.throttle(this._saveLoveChange,this.THROTTLE_DELAY,{leading:!1,trailing:!0})},_bindToDOM:function(){$("body").on("click","a.loves,button.loves,span.loves",$.proxy(this._onHeartClick,this))},_onHeartClick:function(e){if(e.preventDefault(),this._userNeedsToLogin())return this._redirectToLogin();var t=$(e.target).closest(".loves");this._isOwned(t)||this._heartItem(t)},_userNeedsToLogin:function(){return 1==this.user.id},_redirectToLogin:function(){window.location="/login?type=love"},_isOwned:function(e){return e.data("owned")},_heartItem:function(e){var t=this._getNextLevel(e);this._showAsHearted(e,t),this._saveLoveToDBFunc(e.data("item"),e.data("hashid"),t)},_getNextLevel:function(e){if(e.hasClass("comment-heart"))return this._isCommentedLoved(e)?0:1;var t=this._findTextLoveLevel(e.attr("class"));return this._nextLoveLevel(t)},_isCommentedLoved:function(e){return e.hasClass("love")},_findTextLoveLevel:function(e){var t=e.match(/loved-(\d)/);return t?1*t[1]:0},_nextLoveLevel:function(e){return 3===e?0:e+1},_showAsHearted:function(e,t){e.hasClass("comment-heart")?this._showCommentHeartAsHearted(e,t):this._showStandardHeartAsHearted(e,t)},_showCommentHeartAsHearted:function(e,t){t>0?e.addClass("love loved-1"):e.removeClass("love loved-1"),this._updateLoveCount(e,t)},_showStandardHeartAsHearted:function(e,t){e.removeClass("loved-1 loved-2 loved-3 loved-0"),e.addClass("loved-"+t),this._updateLoveCount(e,t)},_updateLoveCount:function(e,t){var s=e.find("span.count"),i=this._getValueToAddToCount(t);s.html(this._getLoveCount(s,i))},_getValueToAddToCount:function(e){return 0===e?-1:1===e?1:0},_getLoveCount:function(e,t){var s=1*e.html(),i=isNaN(s)?0:s;return i+=t,i>0?i:""},_saveLoveChange:function(e,t,s){var i="/love/"+[e,t,s].join("/");this.post(i,{},function(){this._doneSaveLoveChange(e)})},_doneSaveLoveChange:function(e){"undefined"!=typeof Hub&&Hub.pub(e+"-hearted")}};Love.init();var URLBuilder={getHostURL:function(e,t){var s=document.location,i=s.protocol,n=s.hostname,o=e?"s.":"";o=void 0===typeof t?o:t;var r=s.port?":"+s.port:"",a="<%= protocol %>//<%= subdomain %><%= host %><%= port %>";return _.template(a,{protocol:i,subdomain:o,host:n,port:r})},getProtocolLessHostURL:function(e,t){return this.getHostURL(e,t).replace(/(http:|https:)/,"")},getViewURL:function(e,t,s,i){return this.getViewURLSimple(e,t.base_url,s.getActiveSlugHash(),i)},getViewURLSimple:function(e,t,s,i,n){var o="";return o+=n?URLBuilder.getProtocolLessHostURL(i,""):URLBuilder.getHostURL(i),o+=t+"/",o+=e+"/",o+=s+"/"},SHORT_HOST:"http://cdpn.io",getShortViewURL:function(e,t){return e?[this.SHORT_HOST,e,t.getActiveSlugHash()].join("/"):[this.SHORT_HOST,t.getActiveSlugHash()].join("/")}},LocalDataLoader={latestObject:function(e,t,s){if(!s)return e;if("undefined"===s)return e;var i=$.parseJSON(s);return this._localStorageObjNewer(e,t,i)?i:e},_localStorageObjNewer:function(e,t,s){return this._getComparableClientTime(s,t)>t},_getComparableClientTime:function(e,t){var s=e.last_updated+"",i=t+"",n=s.substr(0,i.length);return+n}},Collections=Class.extend({init:function(){_.extend(this,AJAXUtil),this._bindToDOM()},_bindToDOM:function(){$("#collection-choice")._on("change",this.handleCollectionChoice,this)},handleCollectionChoice:function(e,t){var s=t.find("option:selected").val();"__add__"===s?this.addNewCollection():"Collections"!==s&&this.addThisPenToSelectedCollection(s),this.resetDefaultChoice()},resetDefaultChoice:function(){$("#collection-choice").val("Collections")},addNewCollection:function(){var e="/collection/add_new_collection_modal",t="modal-neutral";$.showModal(e,t,$.proxy(this.doneShowNewCollectionsModal,this))},doneShowNewCollectionsModal:function(){$("#name").focus(),$("#add-new-collection-form")._on("submit",this.saveNewCollectionsModal,this)},saveNewCollectionsModal:function(){var e={name:$("#name").val(),description:$("#description").val(),pen_slug_hash:CP.pen.getActiveSlugHash()};this.post("/collection/save",e,this.doneSaveNewCollection)},doneSaveNewCollection:function(e){var t={name:e.name,url:"/collection/"+e.slug_hash},s=_.template(Copy.collectionSavedPenAdded,t);$.showMessage(s,"slow"),this.addNewCollectionToSelect(e)},addNewCollectionToSelect:function(e){$("<option value='"+e.id+"'>"+e.name+"</option>").appendTo("#collection-options")},addThisPenToSelectedCollection:function(e){if(e){var t={collection_id:e,slug_hash:CP.pen.getActiveSlugHash()};$.hideModal(),this.post("/collection/add",t,this.doneAddToCollection)}},doneAddToCollection:function(e){var t={name:e.name,url:"/collection/"+e.slug_hash},s=_.template(Copy.penAddToCollection,t);$.showMessage(s,"slow")}}),Upsell=Class.extend({init:function(){this._bindToDOM()},_bindToDOM:function(){$(".upsell")._on("click",this.showDialog)},showDialog:function(e,t){$.showModal(t.data("url"),"modal-pro")},showDialogFromURL:function(e){$.showModal(e,"modal-pro")}}),CodeEditorAnalyze=Class.extend({clearingShortcut:!1,init:function(){this.bindUIActions()},bindUIActions:function(){$("#analyze-html")._on("click",this.analyzeHTML,this),$("#analyze-css")._on("click",this.analyzeCSS,this),$("#analyze-js")._on("click",this.analyzeJS,this),$(document).on("click","#clear-html-errors",$.proxy(this.clearHTMLErrors,this)).on("click","#clear-css-errors",$.proxy(this.clearCSSErrors,this)).on("click","#clear-js-errors",$.proxy(this.clearJSErrors,this))},enableClearingShortcut:function(){Keytrap.bind("comctrl+shift+8",function(){Analyze.clearAllErrors("html"),Analyze.clearAllErrors("css"),Analyze.clearAllErrors("js")},!0),this.clearingShortcut=!0},analyzeHTML:function(){this._hidePanesOnTopOfEditor("html");var e=this;Loader.run("analyze-html",function(){Analyze.html(),e.clearingShortcut===!1&&e.enableClearingShortcut()})},analyzeCSS:function(){this._hidePanesOnTopOfEditor("css");var e=this;Loader.run("analyze-css",function(){Analyze.css(),e.clearingShortcut===!1&&e.enableClearingShortcut()})},analyzeJS:function(){this._hidePanesOnTopOfEditor("js");var e=this;Loader.run("analyze-js",function(){Analyze.js(),e.clearingShortcut===!1&&e.enableClearingShortcut()})},clearHTMLErrors:function(e){e.preventDefault(),Analyze.clearAllErrors("html"),this._hidePanesOnTopOfEditor("html")},clearCSSErrors:function(e){e.preventDefault(),Analyze.clearAllErrors("css"),this._hidePanesOnTopOfEditor("css")},clearJSErrors:function(e){e.preventDefault(),Analyze.clearAllErrors("js"),this._hidePanesOnTopOfEditor("js")},_hidePanesOnTopOfEditor:function(e){$.hideMessage(),CP[e+"SettingsController"].hideSettingsPane()}}),DIFF_DELETE=-1,DIFF_INSERT=1,DIFF_EQUAL=0;diff_match_patch.Diff,diff_match_patch.prototype.diff_main=function(e,t,s,i){"undefined"==typeof i&&(i=this.Diff_Timeout<=0?Number.MAX_VALUE:(new Date).getTime()+1e3*this.Diff_Timeout);var n=i;if(null==e||null==t)throw new Error("Null input. (diff_main)");if(e==t)return e?[[DIFF_EQUAL,e]]:[];"undefined"==typeof s&&(s=!0);var o=s,r=this.diff_commonPrefix(e,t),a=e.substring(0,r);e=e.substring(r),t=t.substring(r),r=this.diff_commonSuffix(e,t);var l=e.substring(e.length-r);e=e.substring(0,e.length-r),t=t.substring(0,t.length-r);var h=this.diff_compute_(e,t,o,n);return a&&h.unshift([DIFF_EQUAL,a]),l&&h.push([DIFF_EQUAL,l]),this.diff_cleanupMerge(h),h},diff_match_patch.prototype.diff_compute_=function(e,t,s,i){var n;if(!e)return[[DIFF_INSERT,t]];if(!t)return[[DIFF_DELETE,e]];var o=e.length>t.length?e:t,r=e.length>t.length?t:e,a=o.indexOf(r);if(-1!=a)return n=[[DIFF_INSERT,o.substring(0,a)],[DIFF_EQUAL,r],[DIFF_INSERT,o.substring(a+r.length)]],e.length>t.length&&(n[0][0]=n[2][0]=DIFF_DELETE),n;if(1==r.length)return[[DIFF_DELETE,e],[DIFF_INSERT,t]];var l=this.diff_halfMatch_(e,t);if(l){var h=l[0],c=l[1],u=l[2],d=l[3],p=l[4],_=this.diff_main(h,u,s,i),f=this.diff_main(c,d,s,i);return _.concat([[DIFF_EQUAL,p]],f)}return s&&e.length>100&&t.length>100?this.diff_lineMode_(e,t,i):this.diff_bisect_(e,t,i)},diff_match_patch.prototype.diff_lineMode_=function(e,t,s){var i=this.diff_linesToChars_(e,t);e=i.chars1,t=i.chars2;var n=i.lineArray,o=this.diff_main(e,t,!1,s);this.diff_charsToLines_(o,n),this.diff_cleanupSemantic(o),o.push([DIFF_EQUAL,""]);for(var r=0,a=0,l=0,h="",c="";r<o.length;){switch(o[r][0]){case DIFF_INSERT:l++,c+=o[r][1];break;case DIFF_DELETE:a++,h+=o[r][1];break;case DIFF_EQUAL:if(a>=1&&l>=1){o.splice(r-a-l,a+l),r=r-a-l;for(var i=this.diff_main(h,c,!1,s),u=i.length-1;u>=0;u--)o.splice(r,0,i[u]);r+=i.length}l=0,a=0,h="",c=""}r++}return o.pop(),o},diff_match_patch.prototype.diff_bisect_=function(e,t,s){for(var i=e.length,n=t.length,o=Math.ceil((i+n)/2),r=o,a=2*o,l=new Array(a),h=new Array(a),c=0;a>c;c++)l[c]=-1,h[c]=-1;l[r+1]=0,h[r+1]=0;for(var u=i-n,d=u%2!=0,p=0,_=0,f=0,g=0,m=0;o>m&&!((new Date).getTime()>s);m++){for(var b=-m+p;m-_>=b;b+=2){var v,C=r+b;v=b==-m||b!=m&&l[C-1]<l[C+1]?l[C+1]:l[C-1]+1;for(var S=v-b;i>v&&n>S&&e.charAt(v)==t.charAt(S);)v++,S++;if(l[C]=v,v>i)_+=2;else if(S>n)p+=2;else if(d){var y=r+u-b;if(y>=0&&a>y&&-1!=h[y]){var T=i-h[y];if(v>=T)return this.diff_bisectSplit_(e,t,v,S,s)}}}for(var P=-m+f;m-g>=P;P+=2){var T,y=r+P;T=P==-m||P!=m&&h[y-1]<h[y+1]?h[y+1]:h[y-1]+1;for(var E=T-P;i>T&&n>E&&e.charAt(i-T-1)==t.charAt(n-E-1);)T++,E++;if(h[y]=T,T>i)g+=2;else if(E>n)f+=2;else if(!d){var C=r+u-P;if(C>=0&&a>C&&-1!=l[C]){var v=l[C],S=r+v-C;if(T=i-T,v>=T)return this.diff_bisectSplit_(e,t,v,S,s)}}}}return[[DIFF_DELETE,e],[DIFF_INSERT,t]]},diff_match_patch.prototype.diff_bisectSplit_=function(e,t,s,i,n){var o=e.substring(0,s),r=t.substring(0,i),a=e.substring(s),l=t.substring(i),h=this.diff_main(o,r,!1,n),c=this.diff_main(a,l,!1,n);return h.concat(c)},diff_match_patch.prototype.diff_linesToChars_=function(e,t){function s(e){for(var t="",s=0,o=-1,r=i.length;o<e.length-1;){o=e.indexOf("\n",s),-1==o&&(o=e.length-1);var a=e.substring(s,o+1);s=o+1,(n.hasOwnProperty?n.hasOwnProperty(a):void 0!==n[a])?t+=String.fromCharCode(n[a]):(t+=String.fromCharCode(r),n[a]=r,i[r++]=a)}return t}var i=[],n={};i[0]="";var o=s(e),r=s(t);return{chars1:o,chars2:r,lineArray:i}},diff_match_patch.prototype.diff_charsToLines_=function(e,t){for(var s=0;s<e.length;s++){for(var i=e[s][1],n=[],o=0;o<i.length;o++)n[o]=t[i.charCodeAt(o)];e[s][1]=n.join("")}},diff_match_patch.prototype.diff_commonPrefix=function(e,t){if(!e||!t||e.charAt(0)!=t.charAt(0))return 0;for(var s=0,i=Math.min(e.length,t.length),n=i,o=0;n>s;)e.substring(o,n)==t.substring(o,n)?(s=n,o=s):i=n,n=Math.floor((i-s)/2+s);return n},diff_match_patch.prototype.diff_commonSuffix=function(e,t){if(!e||!t||e.charAt(e.length-1)!=t.charAt(t.length-1))return 0;for(var s=0,i=Math.min(e.length,t.length),n=i,o=0;n>s;)e.substring(e.length-n,e.length-o)==t.substring(t.length-n,t.length-o)?(s=n,o=s):i=n,n=Math.floor((i-s)/2+s);return n},diff_match_patch.prototype.diff_commonOverlap_=function(e,t){var s=e.length,i=t.length;if(0==s||0==i)return 0;s>i?e=e.substring(s-i):i>s&&(t=t.substring(0,s));var n=Math.min(s,i);if(e==t)return n;for(var o=0,r=1;;){var a=e.substring(n-r),l=t.indexOf(a);if(-1==l)return o;r+=l,(0==l||e.substring(n-r)==t.substring(0,r))&&(o=r,r++)}},diff_match_patch.prototype.diff_halfMatch_=function(e,t){function s(e,t,s){for(var i,n,o,a,l=e.substring(s,s+Math.floor(e.length/4)),h=-1,c="";-1!=(h=t.indexOf(l,h+1));){var u=r.diff_commonPrefix(e.substring(s),t.substring(h)),d=r.diff_commonSuffix(e.substring(0,s),t.substring(0,h));c.length<d+u&&(c=t.substring(h-d,h)+t.substring(h,h+u),i=e.substring(0,s-d),n=e.substring(s+u),o=t.substring(0,h-d),a=t.substring(h+u))}return 2*c.length>=e.length?[i,n,o,a,c]:null}if(this.Diff_Timeout<=0)return null;var i=e.length>t.length?e:t,n=e.length>t.length?t:e;if(i.length<4||2*n.length<i.length)return null;var o,r=this,a=s(i,n,Math.ceil(i.length/4)),l=s(i,n,Math.ceil(i.length/2));if(!a&&!l)return null;o=l?a&&a[4].length>l[4].length?a:l:a;var h,c,u,d;e.length>t.length?(h=o[0],c=o[1],u=o[2],d=o[3]):(u=o[0],d=o[1],h=o[2],c=o[3]);var p=o[4];return[h,c,u,d,p]},diff_match_patch.prototype.diff_cleanupSemantic=function(e){for(var t=!1,s=[],i=0,n=null,o=0,r=0,a=0,l=0,h=0;o<e.length;)e[o][0]==DIFF_EQUAL?(s[i++]=o,r=l,a=h,l=0,h=0,n=e[o][1]):(e[o][0]==DIFF_INSERT?l+=e[o][1].length:h+=e[o][1].length,n&&n.length<=Math.max(r,a)&&n.length<=Math.max(l,h)&&(e.splice(s[i-1],0,[DIFF_DELETE,n]),e[s[i-1]+1][0]=DIFF_INSERT,i--,i--,o=i>0?s[i-1]:-1,r=0,a=0,l=0,h=0,n=null,t=!0)),o++;for(t&&this.diff_cleanupMerge(e),this.diff_cleanupSemanticLossless(e),o=1;o<e.length;){if(e[o-1][0]==DIFF_DELETE&&e[o][0]==DIFF_INSERT){var c=e[o-1][1],u=e[o][1],d=this.diff_commonOverlap_(c,u),p=this.diff_commonOverlap_(u,c);d>=p?(d>=c.length/2||d>=u.length/2)&&(e.splice(o,0,[DIFF_EQUAL,u.substring(0,d)]),e[o-1][1]=c.substring(0,c.length-d),e[o+1][1]=u.substring(d),o++):(p>=c.length/2||p>=u.length/2)&&(e.splice(o,0,[DIFF_EQUAL,c.substring(0,p)]),e[o-1][0]=DIFF_INSERT,e[o-1][1]=u.substring(0,u.length-p),e[o+1][0]=DIFF_DELETE,e[o+1][1]=c.substring(p),o++),o++}o++}},diff_match_patch.prototype.diff_cleanupSemanticLossless=function(e){function t(e,t){if(!e||!t)return 6;var s=e.charAt(e.length-1),i=t.charAt(0),n=s.match(diff_match_patch.nonAlphaNumericRegex_),o=i.match(diff_match_patch.nonAlphaNumericRegex_),r=n&&s.match(diff_match_patch.whitespaceRegex_),a=o&&i.match(diff_match_patch.whitespaceRegex_),l=r&&s.match(diff_match_patch.linebreakRegex_),h=a&&i.match(diff_match_patch.linebreakRegex_),c=l&&e.match(diff_match_patch.blanklineEndRegex_),u=h&&t.match(diff_match_patch.blanklineStartRegex_);return c||u?5:l||h?4:n&&!r&&a?3:r||a?2:n||o?1:0}for(var s=1;s<e.length-1;){if(e[s-1][0]==DIFF_EQUAL&&e[s+1][0]==DIFF_EQUAL){var i=e[s-1][1],n=e[s][1],o=e[s+1][1],r=this.diff_commonSuffix(i,n);if(r){var a=n.substring(n.length-r);i=i.substring(0,i.length-r),n=a+n.substring(0,n.length-r),o=a+o}for(var l=i,h=n,c=o,u=t(i,n)+t(n,o);n.charAt(0)===o.charAt(0);){i+=n.charAt(0),n=n.substring(1)+o.charAt(0),o=o.substring(1);var d=t(i,n)+t(n,o);d>=u&&(u=d,l=i,h=n,c=o)}e[s-1][1]!=l&&(l?e[s-1][1]=l:(e.splice(s-1,1),s--),e[s][1]=h,c?e[s+1][1]=c:(e.splice(s+1,1),s--))}s++}},diff_match_patch.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,diff_match_patch.whitespaceRegex_=/\s/,diff_match_patch.linebreakRegex_=/[\r\n]/,diff_match_patch.blanklineEndRegex_=/\n\r?\n$/,diff_match_patch.blanklineStartRegex_=/^\r?\n\r?\n/,diff_match_patch.prototype.diff_cleanupEfficiency=function(e){for(var t=!1,s=[],i=0,n=null,o=0,r=!1,a=!1,l=!1,h=!1;o<e.length;)e[o][0]==DIFF_EQUAL?(e[o][1].length<this.Diff_EditCost&&(l||h)?(s[i++]=o,r=l,a=h,n=e[o][1]):(i=0,n=null),l=h=!1):(e[o][0]==DIFF_DELETE?h=!0:l=!0,n&&(r&&a&&l&&h||n.length<this.Diff_EditCost/2&&r+a+l+h==3)&&(e.splice(s[i-1],0,[DIFF_DELETE,n]),e[s[i-1]+1][0]=DIFF_INSERT,i--,n=null,r&&a?(l=h=!0,i=0):(i--,o=i>0?s[i-1]:-1,l=h=!1),t=!0)),o++;t&&this.diff_cleanupMerge(e)},diff_match_patch.prototype.diff_cleanupMerge=function(e){e.push([DIFF_EQUAL,""]);for(var t,s=0,i=0,n=0,o="",r="";s<e.length;)switch(e[s][0]){case DIFF_INSERT:n++,r+=e[s][1],s++;break;case DIFF_DELETE:i++,o+=e[s][1],s++;break;case DIFF_EQUAL:i+n>1?(0!==i&&0!==n&&(t=this.diff_commonPrefix(r,o),0!==t&&(s-i-n>0&&e[s-i-n-1][0]==DIFF_EQUAL?e[s-i-n-1][1]+=r.substring(0,t):(e.splice(0,0,[DIFF_EQUAL,r.substring(0,t)]),s++),r=r.substring(t),o=o.substring(t)),t=this.diff_commonSuffix(r,o),0!==t&&(e[s][1]=r.substring(r.length-t)+e[s][1],r=r.substring(0,r.length-t),o=o.substring(0,o.length-t))),0===i?e.splice(s-n,i+n,[DIFF_INSERT,r]):0===n?e.splice(s-i,i+n,[DIFF_DELETE,o]):e.splice(s-i-n,i+n,[DIFF_DELETE,o],[DIFF_INSERT,r]),s=s-i-n+(i?1:0)+(n?1:0)+1):0!==s&&e[s-1][0]==DIFF_EQUAL?(e[s-1][1]+=e[s][1],e.splice(s,1)):s++,n=0,i=0,o="",r=""}""===e[e.length-1][1]&&e.pop();var a=!1;for(s=1;s<e.length-1;)e[s-1][0]==DIFF_EQUAL&&e[s+1][0]==DIFF_EQUAL&&(e[s][1].substring(e[s][1].length-e[s-1][1].length)==e[s-1][1]?(e[s][1]=e[s-1][1]+e[s][1].substring(0,e[s][1].length-e[s-1][1].length),e[s+1][1]=e[s-1][1]+e[s+1][1],e.splice(s-1,1),a=!0):e[s][1].substring(0,e[s+1][1].length)==e[s+1][1]&&(e[s-1][1]+=e[s+1][1],e[s][1]=e[s][1].substring(e[s+1][1].length)+e[s+1][1],e.splice(s+1,1),a=!0)),s++;a&&this.diff_cleanupMerge(e)},diff_match_patch.prototype.diff_xIndex=function(e,t){var s,i=0,n=0,o=0,r=0;for(s=0;s<e.length&&(e[s][0]!==DIFF_INSERT&&(i+=e[s][1].length),e[s][0]!==DIFF_DELETE&&(n+=e[s][1].length),!(i>t));s++)o=i,r=n;return e.length!=s&&e[s][0]===DIFF_DELETE?r:r+(t-o)},diff_match_patch.prototype.diff_prettyHtml=function(e){for(var t=[],s=/&/g,i=/</g,n=/>/g,o=/\n/g,r=0;r<e.length;r++){var a=e[r][0],l=e[r][1],h=l.replace(s,"&amp;").replace(i,"&lt;").replace(n,"&gt;").replace(o,"&para;<br>");switch(a){case DIFF_INSERT:t[r]='<ins style="background:#e6ffe6;">'+h+"</ins>";break;case DIFF_DELETE:t[r]='<del style="background:#ffe6e6;">'+h+"</del>";break;case DIFF_EQUAL:t[r]="<span>"+h+"</span>"}}return t.join("")},diff_match_patch.prototype.diff_text1=function(e){for(var t=[],s=0;s<e.length;s++)e[s][0]!==DIFF_INSERT&&(t[s]=e[s][1]);return t.join("")},diff_match_patch.prototype.diff_text2=function(e){for(var t=[],s=0;s<e.length;s++)e[s][0]!==DIFF_DELETE&&(t[s]=e[s][1]);return t.join("")},diff_match_patch.prototype.diff_levenshtein=function(e){for(var t=0,s=0,i=0,n=0;n<e.length;n++){var o=e[n][0],r=e[n][1];switch(o){case DIFF_INSERT:s+=r.length;break;case DIFF_DELETE:i+=r.length;break;case DIFF_EQUAL:t+=Math.max(s,i),s=0,i=0}}return t+=Math.max(s,i)},diff_match_patch.prototype.diff_toDelta=function(e){for(var t=[],s=0;s<e.length;s++)switch(e[s][0]){case DIFF_INSERT:t[s]="+"+encodeURI(e[s][1]);break;case DIFF_DELETE:t[s]="-"+e[s][1].length;break;case DIFF_EQUAL:t[s]="="+e[s][1].length}return t.join("	").replace(/%20/g," ")},diff_match_patch.prototype.diff_fromDelta=function(e,t){for(var s=[],i=0,n=0,o=t.split(/\t/g),r=0;r<o.length;r++){var a=o[r].substring(1);switch(o[r].charAt(0)){case"+":try{s[i++]=[DIFF_INSERT,decodeURI(a)]}catch(l){throw new Error("Illegal escape in diff_fromDelta: "+a)}break;case"-":case"=":var h=parseInt(a,10);if(isNaN(h)||0>h)throw new Error("Invalid number in diff_fromDelta: "+a);var c=e.substring(n,n+=h);s[i++]="="==o[r].charAt(0)?[DIFF_EQUAL,c]:[DIFF_DELETE,c];break;default:if(o[r])throw new Error("Invalid diff operation in diff_fromDelta: "+o[r])}}if(n!=e.length)throw new Error("Delta length ("+n+") does not equal source text length ("+e.length+").");return s},diff_match_patch.prototype.match_main=function(e,t,s){if(null==e||null==t||null==s)throw new Error("Null input. (match_main)");return s=Math.max(0,Math.min(s,e.length)),e==t?0:e.length?e.substring(s,s+t.length)==t?s:this.match_bitap_(e,t,s):-1},diff_match_patch.prototype.match_bitap_=function(e,t,s){function i(e,i){var n=e/t.length,r=Math.abs(s-i);return o.Match_Distance?n+r/o.Match_Distance:r?1:n}if(t.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var n=this.match_alphabet_(t),o=this,r=this.Match_Threshold,a=e.indexOf(t,s);-1!=a&&(r=Math.min(i(0,a),r),a=e.lastIndexOf(t,s+t.length),-1!=a&&(r=Math.min(i(0,a),r)));var l=1<<t.length-1;a=-1;for(var h,c,u,d=t.length+e.length,p=0;p<t.length;p++){for(h=0,c=d;c>h;)i(p,s+c)<=r?h=c:d=c,c=Math.floor((d-h)/2+h);d=c;var _=Math.max(1,s-c+1),f=Math.min(s+c,e.length)+t.length,g=Array(f+2);g[f+1]=(1<<p)-1;for(var m=f;m>=_;m--){var b=n[e.charAt(m-1)];if(g[m]=0===p?(g[m+1]<<1|1)&b:(g[m+1]<<1|1)&b|((u[m+1]|u[m])<<1|1)|u[m+1],g[m]&l){var v=i(p,m-1);if(r>=v){if(r=v,a=m-1,!(a>s))break;_=Math.max(1,2*s-a)}}}if(i(p+1,s)>r)break;u=g}return a},diff_match_patch.prototype.match_alphabet_=function(e){for(var t={},s=0;s<e.length;s++)t[e.charAt(s)]=0;for(var s=0;s<e.length;s++)t[e.charAt(s)]|=1<<e.length-s-1;return t},diff_match_patch.prototype.patch_addContext_=function(e,t){if(0!=t.length){for(var s=t.substring(e.start2,e.start2+e.length1),i=0;t.indexOf(s)!=t.lastIndexOf(s)&&s.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)i+=this.Patch_Margin,s=t.substring(e.start2-i,e.start2+e.length1+i);i+=this.Patch_Margin;var n=t.substring(e.start2-i,e.start2);n&&e.diffs.unshift([DIFF_EQUAL,n]);var o=t.substring(e.start2+e.length1,e.start2+e.length1+i);o&&e.diffs.push([DIFF_EQUAL,o]),e.start1-=n.length,e.start2-=n.length,e.length1+=n.length+o.length,e.length2+=n.length+o.length}},diff_match_patch.prototype.patch_make=function(e,t,s){var i,n;if("string"==typeof e&&"string"==typeof t&&"undefined"==typeof s)i=e,n=this.diff_main(i,t,!0),n.length>2&&(this.diff_cleanupSemantic(n),this.diff_cleanupEfficiency(n));else if(e&&"object"==typeof e&&"undefined"==typeof t&&"undefined"==typeof s)n=e,i=this.diff_text1(n);else if("string"==typeof e&&t&&"object"==typeof t&&"undefined"==typeof s)i=e,n=t;else{if("string"!=typeof e||"string"!=typeof t||!s||"object"!=typeof s)throw new Error("Unknown call format to patch_make.");i=e,n=s}if(0===n.length)return[];for(var o=[],r=new diff_match_patch.patch_obj,a=0,l=0,h=0,c=i,u=i,d=0;d<n.length;d++){var p=n[d][0],_=n[d][1];switch(a||p===DIFF_EQUAL||(r.start1=l,r.start2=h),p){case DIFF_INSERT:r.diffs[a++]=n[d],r.length2+=_.length,u=u.substring(0,h)+_+u.substring(h);break;case DIFF_DELETE:r.length1+=_.length,r.diffs[a++]=n[d],u=u.substring(0,h)+u.substring(h+_.length);break;case DIFF_EQUAL:_.length<=2*this.Patch_Margin&&a&&n.length!=d+1?(r.diffs[a++]=n[d],r.length1+=_.length,r.length2+=_.length):_.length>=2*this.Patch_Margin&&a&&(this.patch_addContext_(r,c),o.push(r),r=new diff_match_patch.patch_obj,a=0,c=u,l=h)}p!==DIFF_INSERT&&(l+=_.length),p!==DIFF_DELETE&&(h+=_.length)}return a&&(this.patch_addContext_(r,c),o.push(r)),o},diff_match_patch.prototype.patch_deepCopy=function(e){for(var t=[],s=0;s<e.length;s++){var i=e[s],n=new diff_match_patch.patch_obj;n.diffs=[];for(var o=0;o<i.diffs.length;o++)n.diffs[o]=i.diffs[o].slice();n.start1=i.start1,n.start2=i.start2,n.length1=i.length1,n.length2=i.length2,t[s]=n}return t},diff_match_patch.prototype.patch_apply=function(e,t){if(0==e.length)return[t,[]];e=this.patch_deepCopy(e);var s=this.patch_addPadding(e);t=s+t+s,this.patch_splitMax(e);for(var i=0,n=[],o=0;o<e.length;o++){var r,a=e[o].start2+i,l=this.diff_text1(e[o].diffs),h=-1;if(l.length>this.Match_MaxBits?(r=this.match_main(t,l.substring(0,this.Match_MaxBits),a),-1!=r&&(h=this.match_main(t,l.substring(l.length-this.Match_MaxBits),a+l.length-this.Match_MaxBits),(-1==h||r>=h)&&(r=-1))):r=this.match_main(t,l,a),-1==r)n[o]=!1,i-=e[o].length2-e[o].length1;else{n[o]=!0,i=r-a;var c;if(c=-1==h?t.substring(r,r+l.length):t.substring(r,h+this.Match_MaxBits),l==c)t=t.substring(0,r)+this.diff_text2(e[o].diffs)+t.substring(r+l.length);else{var u=this.diff_main(l,c,!1);if(l.length>this.Match_MaxBits&&this.diff_levenshtein(u)/l.length>this.Patch_DeleteThreshold)n[o]=!1;else{this.diff_cleanupSemanticLossless(u);for(var d,p=0,_=0;_<e[o].diffs.length;_++){var f=e[o].diffs[_];f[0]!==DIFF_EQUAL&&(d=this.diff_xIndex(u,p)),f[0]===DIFF_INSERT?t=t.substring(0,r+d)+f[1]+t.substring(r+d):f[0]===DIFF_DELETE&&(t=t.substring(0,r+d)+t.substring(r+this.diff_xIndex(u,p+f[1].length))),f[0]!==DIFF_DELETE&&(p+=f[1].length)}}}}}return t=t.substring(s.length,t.length-s.length),[t,n]},diff_match_patch.prototype.patch_addPadding=function(e){for(var t=this.Patch_Margin,s="",i=1;t>=i;i++)s+=String.fromCharCode(i);for(var i=0;i<e.length;i++)e[i].start1+=t,e[i].start2+=t;var n=e[0],o=n.diffs;if(0==o.length||o[0][0]!=DIFF_EQUAL)o.unshift([DIFF_EQUAL,s]),n.start1-=t,n.start2-=t,n.length1+=t,n.length2+=t;else if(t>o[0][1].length){var r=t-o[0][1].length;o[0][1]=s.substring(o[0][1].length)+o[0][1],n.start1-=r,n.start2-=r,n.length1+=r,n.length2+=r}if(n=e[e.length-1],o=n.diffs,0==o.length||o[o.length-1][0]!=DIFF_EQUAL)o.push([DIFF_EQUAL,s]),n.length1+=t,n.length2+=t;else if(t>o[o.length-1][1].length){var r=t-o[o.length-1][1].length;o[o.length-1][1]+=s.substring(0,r),n.length1+=r,n.length2+=r}return s},diff_match_patch.prototype.patch_splitMax=function(e){for(var t=this.Match_MaxBits,s=0;s<e.length;s++)if(!(e[s].length1<=t)){var i=e[s];e.splice(s--,1);for(var n=i.start1,o=i.start2,r="";0!==i.diffs.length;){var a=new diff_match_patch.patch_obj,l=!0;for(a.start1=n-r.length,a.start2=o-r.length,""!==r&&(a.length1=a.length2=r.length,a.diffs.push([DIFF_EQUAL,r]));0!==i.diffs.length&&a.length1<t-this.Patch_Margin;){var h=i.diffs[0][0],c=i.diffs[0][1];h===DIFF_INSERT?(a.length2+=c.length,o+=c.length,a.diffs.push(i.diffs.shift()),l=!1):h===DIFF_DELETE&&1==a.diffs.length&&a.diffs[0][0]==DIFF_EQUAL&&c.length>2*t?(a.length1+=c.length,n+=c.length,l=!1,a.diffs.push([h,c]),i.diffs.shift()):(c=c.substring(0,t-a.length1-this.Patch_Margin),a.length1+=c.length,n+=c.length,h===DIFF_EQUAL?(a.length2+=c.length,o+=c.length):l=!1,a.diffs.push([h,c]),c==i.diffs[0][1]?i.diffs.shift():i.diffs[0][1]=i.diffs[0][1].substring(c.length))}r=this.diff_text2(a.diffs),r=r.substring(r.length-this.Patch_Margin);var u=this.diff_text1(i.diffs).substring(0,this.Patch_Margin);""!==u&&(a.length1+=u.length,a.length2+=u.length,0!==a.diffs.length&&a.diffs[a.diffs.length-1][0]===DIFF_EQUAL?a.diffs[a.diffs.length-1][1]+=u:a.diffs.push([DIFF_EQUAL,u])),l||e.splice(++s,0,a)}}},diff_match_patch.prototype.patch_toText=function(e){for(var t=[],s=0;s<e.length;s++)t[s]=e[s];return t.join("")},diff_match_patch.prototype.patch_fromText=function(e){var t=[];if(!e)return t;for(var s=e.split("\n"),i=0,n=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;i<s.length;){var o=s[i].match(n);if(!o)throw new Error("Invalid patch string: "+s[i]);var r=new diff_match_patch.patch_obj;for(t.push(r),r.start1=parseInt(o[1],10),""===o[2]?(r.start1--,r.length1=1):"0"==o[2]?r.length1=0:(r.start1--,r.length1=parseInt(o[2],10)),r.start2=parseInt(o[3],10),""===o[4]?(r.start2--,r.length2=1):"0"==o[4]?r.length2=0:(r.start2--,r.length2=parseInt(o[4],10)),i++;i<s.length;){var a=s[i].charAt(0);try{var l=decodeURI(s[i].substring(1))}catch(h){throw new Error("Illegal escape in patch_fromText: "+l)}if("-"==a)r.diffs.push([DIFF_DELETE,l]);else if("+"==a)r.diffs.push([DIFF_INSERT,l]);else if(" "==a)r.diffs.push([DIFF_EQUAL,l]);else{if("@"==a)break;if(""!==a)throw new Error('Invalid patch mode "'+a+'" in: '+l)}i++}}return t},diff_match_patch.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0},diff_match_patch.patch_obj.prototype.toString=function(){var e,t;e=0===this.length1?this.start1+",0":1==this.length1?this.start1+1:this.start1+1+","+this.length1,t=0===this.length2?this.start2+",0":1==this.length2?this.start2+1:this.start2+1+","+this.length2;for(var s,i=["@@ -"+e+" +"+t+" @@\n"],n=0;n<this.diffs.length;n++){switch(this.diffs[n][0]){case DIFF_INSERT:s="+";break;case DIFF_DELETE:s="-";break;case DIFF_EQUAL:s=" "}i[n+1]=s+encodeURI(this.diffs[n][1])+"\n"}return i.join("").replace(/%20/g," ")},this.diff_match_patch=diff_match_patch,this.DIFF_DELETE=DIFF_DELETE,this.DIFF_INSERT=DIFF_INSERT,this.DIFF_EQUAL=DIFF_EQUAL;var BaseEditor=Class.extend({editor:"",_viewingSource:!1,_enabled:!0,type:"",value:"",init:function(e,t){this.type=e,this.value=t,this.keyBindings=__keyBindings,this.pageType=__pageType,this.mobile=__mobile,this.dmp=new diff_match_patch,this._onEditorChangeFunc=$.proxy(this._onEditorChange,this),_.extend(this,BaseEditorCommon),_.extend(this,BaseEditorSetValueMixin),_.extend(this,BaseEditorScrollingMixin),_.extend(this,BaseEditorViewSourceMixin),_.extend(this,BaseEditorCursorMixin),this._baseBindToHub(),this._loadTabSnippets(this.type),this._buildEditor()},_baseBindToHub:function(){Hub.sub("ui-disable",$.proxy(this._disableUI,this)),Hub.sub("ui-enable",$.proxy(this._enableUI,this)),Hub.sub("page-loading-done",$.proxy(this._onPageLoadingDone,this)),Hub.sub("editor-refresh",$.proxy(this.refresh,this)),Hub.sub("editor-lose-focus",$.proxy(this._onEditorLoseFocus,this)),Hub.sub("key",$.proxy(this._onKey,this)),Hub.sub("sync-other-cursor",$.proxy(this._onSyncOtherCursor,this)),Hub.sub("cm-update-keybindings",$.proxy(this._onCmUpdateKeyBindings,this)),Hub.sub("server-pen-change",$.proxy(this._onServerPenChange,this)),Hub.sub("server-ui-change",$.proxy(this._onServerUIChange,this))},_onKey:function(e,t){"esc"===t.key&&(this.editor.execCommand("clearSearch"),this.runRefresh(200))},_onServerPenChange:function(e,t){"professor"===this.pageType&&this.type in t.pen&&this.setEditorValueInProfessor(t.pen[this.type])},_onServerUIChange:function(e,t){var s="";if("textSelection"in t.ui)for(s in t.ui.textSelection)s===this.type&&this._setEditorSelection(t.ui.textSelection[s]);if("scrollTopLine"in t.ui)for(s in t.ui.scrollTopLine)s===this.type&&this._scrollToLine(t.ui.scrollTopLine[s])},_onPageLoadingDone:function(){this._indentWrappedLines(),this.runRefresh(200)},_buildEditor:function(){this.editor=this._buildCMEditor(this._getEditorConfig()),this._setMode(),this._bindToHub(),this.editor.setOption("showCursorWhenSelecting",!0),this.editor.setOption("autoCloseBrackets",!0),this.editor.setOption("cursorScrollMargin",30),this._setEditorTypeSpecificOptions(),this._conditionallyLoadCMKeyBindings(),this.bindToOnChange(),this._bindToRealtimeEditorEvents()},_getEditorConfig:function(){var e=this._getDefaultEditorConfig(this.value);return _.extend(e,this._getEditorTypeSpecificConfig()),e},_getDefaultEditorConfig:function(e){return{lineNumbers:!0,value:e,tabSize:2,indentWithTabs:!1,matchBrackets:!0,lineWrapping:!0}},_buildCMEditor:function(e){var t=this._getTextAreaElementToReplaceWithCodeMirror();return CodeMirror(function(e){t.parentNode.replaceChild(e,t)},e)},_getTextAreaElementToReplaceWithCodeMirror:function(){var e="#"+this.type;return $(e)[0]},_conditionallyLoadCMKeyBindings:function(){_.isUndefined(window.CMKeyBindings)||this.editor.on("keydown",$.proxy(CMKeyBindings.handleKeydown,CMKeyBindings))},_bindToRealtimeEditorEvents:function(){"professor"===this.pageType?(this.editor.on("cursorActivity",$.proxy(this._onCursorActivity,this)),this.editor.on("scroll",$.proxy(this._onScroll,this))):"collab"===this.pageType&&this.editor.on("cursorActivity",$.proxy(this._onCursorActivity,this))},_disableUI:function(){this._enabled=!1,this.editor.setOption("readOnly",!0)},_enableUI:function(){this._enabled=!0,this.editor.setOption("readOnly",!1)},_preProcessorChanged:function(e){this._turnOffReadOnlyView(),this._changeMode(e),this._loadTabSnippets(this.type)},_turnOffReadOnlyView:function(){this._viewingSource&&this.showOriginalCode()},LOAD_TAB_SNIPPETS_WAIT_TIME:500,_loadTabSnippets:function(e){_.isUndefined(window.TabSnippets)||setTimeout(function(){TabSnippets.loadSnippet(e)},this.LOAD_TAB_SNIPPETS_WAIT_TIME)},unbindOnChange:function(){this.editor.off("change",this._onEditorChangeFunc)},bindToOnChange:function(){this.editor.on("change",this._onEditorChangeFunc)},_onEditorChange:function(e){var t=this.editor.getOption("readOnly");if(t===!1){var s={origin:"client",pen:{}};s.pen[this.type]=e.getValue(),CP.pen.setPenValue(s)}},getValue:function(){return this.editor.getValue()},_setMode:function(){var e=this._getBasicType(),t=CP.pen[e+"_pre_processor"];this._changeMode(t)},getMode:function(){var e=this._getBasicType(),t=CP.pen[e+"_pre_processor"];return EditorModes.getCMMode(t,e)},_changeMode:function(e){var t=this,s=this._getBasicType(),i=EditorModes.getLoaderMode(e,s),n=EditorModes.getCMMode(e,s);Loader.run(i,function(){t.editor&&t.editor.setOption("mode",n)})},_getBasicType:function(){throw"Implement in subclass"},hasFocus:function(){return this.editor.hasFocus()},refresh:function(e,t){this.runRefresh(t.delay)},runRefresh:function(e){e>0?setTimeout($.proxy(function(){this.runRefresh()},this),e):this.editor.refresh()}}),BaseEditorCommon={_onCmUpdateKeyBindings:function(){"vim"===this.keyBindings?this.editor.setOption("vimMode",!0):"subl"===this.keyBindings&&this.editor.setOption("keyMap","sublime")},_indentWrappedLines:function(){var e=this.editor.defaultCharWidth(),t=2;this.editor.on("renderLine",function(s,i,n){var o=s.getOption("tabSize"),r=CodeMirror.countColumn(i.text,null,o),a=r*e;n.style.textIndent="-"+a+"px",n.style.paddingLeft=t+a+"px"})}},BaseEditorCursorMixin={_setEditorSelection:function(e){Hub.pub("editor-lose-focus",{}),this._onEditorGainFocus(),this._setEditorCursorOrSelection(e)
},_setEditorCursorOrSelection:function(e){var t=e.start,s=e.end;if(t.ch!==s.ch||t.line!==s.line)this.editor.doc.setSelection(e.start,e.end);else{var i={line:t.line,ch:t.ch};this.editor.setCursor(i)}},_onEditorGainFocus:function(){$("#box-"+this.type).addClass("student"),this.editor.pseudoFocus()},_onEditorLoseFocus:function(){$("#box-"+this.type).removeClass("student"),this.editor.pseudoLostFocus()},_throttledHandleCollabCursorActivity:!1,_THROTTLE:200,_onCursorActivity:function(e){if("professor"===this.pageType)this._handleProfessorOnCursorActivity(e);else if("collab"===this.pageType){if(!this._throttledHandleCollabCursorActivity){var t=this;this._throttledHandleCollabCursorActivity=_.throttle(function(e){t._handleCollabOnCursorActivity(e)},this._THROTTLE,{leading:!0,trailing:!1})}this._throttledHandleCollabCursorActivity(e)}},_handleProfessorOnCursorActivity:function(e){var t=this._getOnCursorActivityData(e);CP.ui.textSelection[this.type]=t.ui.textSelection[this.type],Hub.pub("ui-change",t)},_getOnCursorActivityData:function(e){var t={ui:{textSelection:{}}};return t.ui.textSelection[this.type]=this._getCursorsHash(e),t},_handleCollabOnCursorActivity:function(e){this._updateCursorsMap(e)},_cursors:{},_clientID:{},_prevOtherCursors:{},_onSyncOtherCursor:function(e,t){this._clientID=t.clientID,this._cursors=t.cursors,this._initClientCursorState()},_initClientCursorState:function(){this._cursors.get(this._clientID)||this._cursors.set(this._clientID,{}),this._updateCursorsMap(this.editor)},_CLEAR_UNUSED_CURSOR_TIMEOUT:1e4,showOtherCursor:function(e,t){this._cleanUpPrevCursors(e);var s=t[this.type],i=this._getOtherClientColor(e),n=this._setSimpleCurosr(i,e,s);this._prevOtherCursors[e]=n,setTimeout(function(){n.clear()},this._CLEAR_UNUSED_CURSOR_TIMEOUT)},_cleanUpPrevCursors:function(e){this._prevOtherCursors[e]&&this._prevOtherCursors[e].clear()},_otherClientColors:{},_colors:["#1abc9c","#e67e22","#3498db","#f39c12","#9b59b6","#f1c40f"],_getOtherClientColor:function(e){return this._otherClientColors[e]||(this._otherClientColors[e]=this._colors.pop()),this._otherClientColors[e]},_setSimpleCurosr:function(e,t,s){var i=this._buildPseudoCursorEl(e,t,s);return this.editor.addWidget(s.start,i,!1),{clear:function(){var e=i.parentNode;e&&e.removeChild(i)}}},_buildPseudoCursorEl:function(e,t,s){var i=this.editor.charCoords(s.start),n=document.createElement("pre");return n.className="other-client",n.style.borderLeftWidth="2px",n.style.borderLeftStyle="solid",n.innerHTML="&nbsp;",n.style.borderLeftColor=e,n.style.height=.9*(i.bottom-i.top)+"px",n.style.marginTop=i.top-i.bottom+"px",n.style.zIndex=0,n},_updateCursorsMap:function(e){var t={};t[this.type]=this._getCursorsHash(e),this._shouldUpdateCursors(t[this.type])&&this._cursors.set(this._clientID,t)},_shouldUpdateCursors:function(e){return 0===e.start.line&&0===e.start.ch&&0===e.end.line&&0===e.start.ch?!1:!0},_getCursorsHash:function(e){return{start:e.doc.getCursor(!0),end:e.doc.getCursor(!1)}}},BaseEditorScrollingMixin={SHOW_PREVIOUS_LINES:1,$scrollableElement:!1,getScrollTopLine:function(){return Math.floor(this._getScrollTop()/this._getLineHeight())},_getScrollTop:function(){return this._getScrollableElement().scrollTop()},_setScrollTop:function(e){this._getScrollableElement().scrollTop(e)},_scrollToLine:function(e){var t;t=e>this.SHOW_PREVIOUS_LINES?e-this.SHOW_PREVIOUS_LINES:e;var s=Math.floor(this._getLineHeight()*t);this._setScrollTop(s)},_getLineHeight:function(){var e=this._getScrollableElement()[0].scrollHeight;return e/this.editor.lineCount()},_getScrollableElement:function(){if(!this.$scrollableElement&&(this.$scrollableElement=$("#box-"+this.type+" .CodeMirror-scroll"),this.$scrollableElement.length<0))throw new Error("Unable to sync scroll. Please contact support@codepen.io.");return this.$scrollableElement},_onScroll:function(){var e={ui:{scrollTopLine:{}}};e.ui.scrollTopLine[this.type]=this.getScrollTopLine(),Hub.pub("ui-change",e)}},BaseEditorSetValueMixin={setValue:function(e){this.editor.setValue(e)},SCROLL_PAST_LINES:5,setEditorValueInProfessor:function(e){var t=this.editor.getCursor();this.editor.setValue(e),this.editor.setCursor(t),t.line+this.SCROLL_PAST_LINES<this.editor.lineCount()&&(t.line+=this.SCROLL_PAST_LINES,this.editor.scrollIntoView(t))},setEditorValueInCollab:function(e){var t=this.editor.lineCount(),s=this.editor.getCursor(),i=this.editor.getLine(s.line)||"",n=this._getScrollTop(),o=i.substring(0,s.ch),r=s.ch;this._setEditorValue(e),s.line=this._calculateCursorLineNumber(i,s.line,t,r),s.ch=this._calculateCursorChPosition(s.line,s.ch,o,i),this.editor.setCursor(s.line,s.ch),this._setScrollTop(n),this._setPenValueInCollab(e)},_setPenValueInCollab:function(e){var t={origin:"server",pen:{}};t.pen[this.type]=e,CP.pen.setPenValue(t)},_setEditorValue:function(e){this.unbindOnChange(),this.editor.setValue(e),this.bindToOnChange()},_calculateCursorLineNumber:function(e,t,s,i){e=e||"";var n=this.editor.lineCount(),o=Math.abs(s-n);if(0===o)return t;for(var r="",a=0,l=0,h=0;o+1>h;h++)if(0===h){if(r=this.editor.getLine(t)||"",this._calcLineMatchScore(r,e,i)>-1)return t}else{if(t-h>-1){a=t-h,r=this.editor.getLine(a)||"";var c=this._calcLineMatchScore(r,e,i);if(c>-1)return a}if(n>t+h){l=t+h,r=this.editor.getLine(l)||"";var u=this._calcLineMatchScore(r,e,i);if(u>-1)return l}}return t},MAX_OLD_LINE_LENGTH:30,_calcLineMatchScore:function(e,t,s){return s=s>0?s:1,this.dmp.Match_Distance=e.length,t=t.substring(0,this.MAX_OLD_LINE_LENGTH),this.dmp.Match_Threshold=.4,this.dmp.match_main(e,t,s)},_calculateCursorChPosition:function(e,t,s,i){var n=this.editor.getLine(e)||"",o=n.substring(0,t);return s!==o&&(t+=n.length-i.length,t=0>t?0:t),t}},BaseEditorViewSourceMixin={showSource:function(){this.unbindOnChange(),this._makeEditorReadOnly(),this._showSource(),this._removeEventFromEditorUndoHistory()},_showSource:function(){CP.penErrorHandler.clearPreprocWidgets(this.type),this._setEditorValue(CP.penRenderer.getPostProcessed(this.type))},_makeEditorReadOnly:function(){$("#box-"+this.type).addClass("view-compiled"),$("#viewsource-"+this.type).attr("title",Copy.returnToSource),this.editor.setOption("readOnly",!0)},showOriginalCode:function(){this._showOriginalCode(),this._makeEditable(),this.bindToOnChange(),this._removeEventFromEditorUndoHistory()},_removeEventFromEditorUndoHistory:function(){var e=this.editor.getHistory();e.done.pop(),e.done.pop(),this.editor.setHistory(e)},_showOriginalCode:function(){this._setEditorValue(CP.pen[this.type])},_makeEditable:function(){$("#box-"+this.type).removeClass("view-compiled view-preproc-errors"),$("#viewsource-"+this.type).attr("title",Copy.viewSource),this._enabled&&this.editor.setOption("readOnly",!1)}},CSSEditor=BaseEditor.extend({_getBasicType:function(){return"css"},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this)),Hub.sub("page-loading-done",$.proxy(this._onPageLoadingDone,this))},_onPenChange:function(e,t){"css_pre_processor"in t.pen&&this._preProcessorChanged(t.pen.css_pre_processor)},_onPageLoadingDone:function(){this.mobile&&setTimeout($.proxy(function(){this.editor.focus()},this),400)},_getEditorTypeSpecificConfig:function(){return{mode:this.getMode()}},_setEditorTypeSpecificOptions:function(){this.mobile||emmetCodeMirror.emmet.preferences.set("css.autoInsertVendorPrefixes",!1)}}),EditorModes={htmlModes:{text:"text",none:{name:"xml",htmlMode:!0},html:{name:"xml",htmlMode:!0},haml:"haml",slim:"application/x-slim",markdown:"markdown",jade:"jade"},htmlLoaderModes:{text:"text",none:"xml",html:"xml",haml:"haml",slim:"application/x-slim",markdown:"markdown",jade:"jade"},cssModes:{none:"text/css",css:"text/css",scss:"text/x-scss",stylus:"text/x-scss",less:"text/x-less",sass:"text/x-sass"},jsModes:{none:"javascript",js:"javascript",coffeescript:"coffeescript",livescript:"livescript",traceur:"javascript"},getLoaderMode:function(e,t){return"html"===t?e in this.htmlLoaderModes?"mode_"+this.htmlLoaderModes[e]:"mode_text":"css"===t?e in this.cssModes?"mode_"+this.cssModes[e]:"mode_text":"js"===t?e in this.jsModes?"mode_"+this.jsModes[e]:"mode_text":void 0},getCMMode:function(e,t){return"html"===t?e in this.htmlModes?this.htmlModes[e]:"text":"css"===t?e in this.cssModes?this.cssModes[e]:"text":"js"===t?e in this.jsModes?this.jsModes[e]:"text":void 0}},HTMLEditor=BaseEditor.extend({_getBasicType:function(){return"html"},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_onPenChange:function(e,t){"html_pre_processor"in t.pen&&this._preProcessorChanged(t.pen.html_pre_processor)},_getEditorTypeSpecificConfig:function(){return{mode:this.getMode(),syntax:"html",profile:"xhtml",autofocus:!0}},_setEditorTypeSpecificOptions:function(){}}),JSEditor=BaseEditor.extend({_getBasicType:function(){return"js"},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_onPenChange:function(e,t){"js_pre_processor"in t.pen&&this._preProcessorChanged(t.pen.js_pre_processor)},_getEditorTypeSpecificConfig:function(){return{mode:this.getMode()}},_setEditorTypeSpecificOptions:function(){this.editor.setOption("extraKeys",{Tab:function(e){if(e.doc.somethingSelected())return CodeMirror.Pass;var t=e.getOption("indentUnit"),s=t-e.doc.getCursor("start").ch%t,i=Array(s+1).join(" ");e.replaceSelection(i,"end","+input")}})}}),CodeEditorsResizeController=Class.extend({init:function(){this.model=new CodeEditorResizeModel,this.events=new CodeEditorsResizeEvents(this),this.view=new CodeEditorsResizeView(this.model)},setAllEditorsState:function(e){this.model.setAllEditorsState(e)},toggleExpander:function(e,t){this.model.toggleExpander(e,t)},toggleCollapser:function(e){this.model.toggleCollapser(e)},syncWithServer:function(e){this.model.syncWithServer(e)}}),CodeEditorsResizeEvents=Class.extend({_enabled:!0,timer:0,delay:100,prevent:!1,$editorToggleButtons:$(".editor-toggle-button"),$closeEditorButtons:$(".close-editor-button"),init:function(e){this.controller=e,this._bindToDOM(),this._bindToHub()},_bindToHub:function(){Hub.sub("key",$.proxy(this._onKey,this)),Hub.sub("ui-disable",$.proxy(this._disableUI,this)),Hub.sub("ui-enable",$.proxy(this._enableUI,this)),Hub.sub("server-ui-change",$.proxy(this._onServerUIChange,this))},_disableUI:function(){this._enabled=!1},_enableUI:function(){this._enabled=!0},_onServerUIChange:function(e,t){"editorSizes"in t.ui&&this.controller.syncWithServer(t)},_onKey:function(){},_bindToDOM:function(){this.$editorToggleButtons._on("click",this._onEditorToggleClick,this,!0),this.$closeEditorButtons._on("click",this._onEditorToggleClick,this,!0),this.$closeEditorButtons._on("dblclick",this._onEditorToggleDblClick,this,!0)},_onEditorToggleClick:function(e,t){var s=this;this.timer=setTimeout(function(){if(!s.prevent&&s._enabled){if($(t).hasClass("active")&&s._onlyOneLeft())return!1;if($(t).hasClass("close-editor-button")){var e="#editor-toggle-button-"+$(t).data("type").toLowerCase();return $(e).click(),!1}var i={type:t.data("type").toLocaleLowerCase()};s.controller.toggleExpander(i,t)}s.prevent=!1},this.delay)},_onEditorToggleDblClick:function(e,t){clearTimeout(this.timer),this.prevent=!0,$(".close-editor-button").each(function(){var e=$(this),s=e.data("type"),i=s.toLowerCase();s!==t.data("type")&&"open"===CP.ui.editorSizes[i]&&e.trigger("click")})},_onlyOneLeft:function(){var e=0;return"open"===CP.ui.editorSizes.html&&e++,"open"===CP.ui.editorSizes.css&&e++,"open"===CP.ui.editorSizes.js&&e++,e>1?!1:!0}}),CodeEditorResizeModel=Class.extend({OPEN:"open",CLOSED:"closed",init:function(){this.initStateOfEditors()},initStateOfEditors:function(){CP.ui.editorSizes.html=$("#editor-toggle-button-html").hasClass("active")?"open":"closed",CP.ui.editorSizes.css=$("#editor-toggle-button-css").hasClass("active")?"open":"closed",CP.ui.editorSizes.js=$("#editor-toggle-button-js").hasClass("active")?"open":"closed"},setAllEditorsState:function(e){this._ensureStateIsValid(e.state),this._setAllTo(e.state),this._publishChangeEvent()},_ensureStateIsValid:function(e){if(e!==this.OPEN&&e!==this.CLOSED)throw"Bad State: '"+e+"'"},toggleExpander:function(e,t){this._updateDataAfterToggleExpander(e.type),this._publishChangeEvent(t)},_updateDataAfterToggleExpander:function(e){CP.ui.editorSizes[e]="closed"===CP.ui.editorSizes[e]?"open":"closed"},_setAllTo:function(e){CP.ui.editorSizes.html=e,CP.ui.editorSizes.css=e,CP.ui.editorSizes.js=e},syncWithServer:function(e){CP.ui.editorSizes=e.ui.editorSizes,this._publishChangeEvent()},_publishChangeEvent:function(e){var t={ui:{editorSizes:CP.ui.editorSizes},el:e};Hub.pub("ui-change",t)}}),CodeEditorsResizeView=Class.extend({$topBoxes:$("body"),$layoutLinks:$(".layout-change-icon"),init:function(e){this.data=e,this._initStateOfEditorLayoutLinks(),this._bindToHub()},_initStateOfEditorLayoutLinks:function(){var e=location.href.split("?");if(e.length>1){var t="?"+e[1];this._updateEditorLayoutLinks(t)}},_bindToHub:function(){Hub.sub("ui-change",$.proxy(this._onUIChange,this))},_onUIChange:function(e,t){t.ui.editorSizes&&(this._updateURLAndTopBoxesAfterStateChange(t),("right"===__layoutType||"left"===__layoutType)&&($("body").addClass("hide-code-while-resizing"),setTimeout(function(){Layout.setUpCodeEditorHeights(),$("body").removeClass("hide-code-while-resizing")},500))),t.el&&($(t.el).toggleClass("active"),"JS"===t.el[0].innerText&&$("#box-html, #box-css").css("flex","1"))},_updateURLAndTopBoxesAfterStateChange:function(e){var t=this._getStateClass(e);this._updateURLParamRelated(e),this._setTopBoxesClass(t)},_getStateClass:function(e){var t="state-";return t+=e.ui.editorSizes.html!==this.data.CLOSED?"htmlOn":"htmlOff",t+=e.ui.editorSizes.css!==this.data.CLOSED?"-cssOn":"-cssOff",t+=e.ui.editorSizes.js!==this.data.CLOSED?"-jsOn":"-jsOff"},_setTopBoxesClass:function(e){var t=this.$topBoxes.attr("class")||"",s=this._replaceCurrentStateClassWithNew(t,e);this.$topBoxes.attr("class",s)},_replaceCurrentStateClassWithNew:function(e,t){return e.match(/state-\S+/)?e.replace(/state-\S+/,t):e+" "+t},_updateURLParamRelated:function(e){var t=this._buildURLParamFromStateClass(e);this._updateEditorStateURL(t),this._updateEditorLayoutLinks(t)},_buildURLParamFromStateClass:function(e){var t="";return e.ui.editorSizes&&(t+="open"===e.ui.editorSizes.html?"1":"0",t+="open"===e.ui.editorSizes.css?"1":"0",t+="open"===e.ui.editorSizes.js?"1":"0"),"111"===t||"000"===t?"":"?editors="+t},_updateEditorStateURL:function(e){var t=window.location.protocol+"//"+window.location.host+window.location.pathname,s=t+e;history.replaceState("","",s)},_updateEditorLayoutLinks:function(e){_(this.$layoutLinks).forEach(function(t){var s=$(t),i=s.attr("href"),n=i.split("?")[0];s.attr("href",n+e)})}}),TransitionsUtil=Class.extend({_transitionEl:document.createElement("fakeelement"),_transitions:{transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"},init:function(){},getBrowserTransitionEventName:function(){for(var e in this._transitions)if(void 0!==this._transitionEl.style[e])return this._transitions[e]}}),CodeEditorsCSSTransitionHandler=Class.extend({init:function(){this._bindToDOM()},_bindToDOM:function(){$(".box")._on(this._getBrowserTransitionEventName(),this._refreshEditorAtEndOfTransition,this)},_getBrowserTransitionEventName:function(){var e=new TransitionsUtil;return e.getBrowserTransitionEventName()},_refreshEditorAtEndOfTransition:function(){Hub.pub("editor-refresh",{delay:200})}}),CodeEditorsLinkClicker=Class.extend({regex:/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/,commentsWithLinks:".CodeMirror .cm-comment:contains('http://')",init:function(){this._bindToDOM(),this.fixRightClick()},_bindToDOM:function(){$("body").on("mouseenter",this.commentsWithLinks,function(){}).on("mouseleave",this.commentsWithLinks,function(){$(this).removeClass("link-hover")}).on("click",this.commentsWithLinks,$.proxy(this.openEditorCommentLink,this))},openEditorCommentLink:function(e){var t=e.target.textContent,s=t.match(this.regex);window.location=s[0]},fixRightClick:function(){var e=$(".top-boxes");$("body").on("contextmenu",".top-boxes",function(){e.addClass("hacky-overflow-fix"),setTimeout(function(){e.removeClass("hacky-overflow-fix")},10)})}}),CodeEditorsUtil={getEditorByType:function(e){return"html"===e?CP.htmlEditor:"css"===e?CP.cssEditor:CP.jsEditor}},CodeEditorsViewSourceController=Class.extend({init:function(){this.model=new CodeEditorsViewSourceModel,this.events=new CodeEditorsViewSourceEvents(this),this.view=new CodeEditorsViewSourceView},toggleViewSource:function(e){this.model.toggleViewSource(e)},syncWithServer:function(e){this.model.syncWithServer(e)}}),CodeEditorsViewSourceEvents=Class.extend({_enabled:!0,init:function(e){this.controller=e,this._bindToDOM(),this._bindToHub()},_bindToDOM:function(){$(".view-compiled-button")._on("click",this._toggleViewSource,this)},_bindToHub:function(){Hub.sub("ui-disable",$.proxy(this._disableUI,this)),Hub.sub("ui-enable",$.proxy(this._enableUI,this)),Hub.sub("server-ui-change",$.proxy(this._onServerUIChange,this))},_disableUI:function(){this._enabled=!1},_enableUI:function(){this._enabled=!0},_onServerUIChange:function(e,t){"editorViewSource"in t.ui&&this.controller.syncWithServer(t)},_toggleViewSource:function(e,t){if(this._enabled){var s=this._getType(t);if(this._allowedToToggleSourceView(s)){var i={type:s};this.controller.toggleViewSource(i)}else $.showMessage(Copy.cleanErrorsFirst)}},_getType:function(e){var t=$(e).closest("button");return t.data("type").toLowerCase()},_allowedToToggleSourceView:function(e){return!CP.penErrorHandler.editorHasErrors(e)}}),CodeEditorsViewSourceModel=Class.extend({init:function(){},toggleViewSource:function(e){var t=this._getSource(e.type)?!1:!0;this._setSource(e.type,t),this._publishChangeEvent(e)},_getSource:function(e){return CP.ui.editorViewSource[e]},_setSource:function(e,t){CP.ui.editorViewSource[e]=t},syncWithServer:function(e){for(var t in e.ui.editorViewSource){CP.ui.editorViewSource[t]=e.ui.editorViewSource[t];var s={type:t};this._publishChangeEvent(s)}},_publishChangeEvent:function(e){var t={ui:{editorViewSource:{}}};t.ui.editorViewSource[e.type]=this._getSource(e.type),Hub.pub("ui-change",t)}}),CodeEditorsViewSourceView=Class.extend({init:function(){this._bindToHub()},_bindToHub:function(){Hub.sub("ui-change",$.proxy(this._onUIChange,this))},_onUIChange:function(e,t){if(t.ui&&t.ui.editorViewSource)for(var s in t.ui.editorViewSource)this._toggleViewSource(s,t.ui.editorViewSource[s])},_toggleViewSource:function(e,t){var s=CodeEditorsUtil.getEditorByType(e);t?s.showSource():s.showOriginalCode()}}),CMComments={comment:function(e,t){"html"===t?this.commentHTML(e):"css"===t?this.commentCSS(e):"js"===t&&this.commentJS(e)},commentHTML:function(e){"slim"===CP.pen.html_pre_processor?this.prefixComments(e,"/!"):_.contains(["haml","jade"],CP.pen.html_pre_processor)?this.prefixComments(e,"/"):"markdown"===CP.pen.html_pre_processor?this.wrapComments(e,"<!---","--->"):this.wrapComments(e,"<!--","-->")},commentCSS:function(e){this.wrapComments(e,"/*","*/")},commentJS:function(e){_.contains(["coffeescript","livescript"],CP.pen.js_pre_processor)?this.wrapComments(e,"###","###"):this.wrapComments(e,"/*","*/")},prefixComments:function(e,t){for(var s=e.getSelection().split("\n"),i="",n="",o=!0,r=0;r<s.length;r++)i+=t+s[r],r+1<s.length&&(i+="\n"),s[r].substring(0,t.length)===t?o&&(n+=s[r].substring(t.length,s[r].length),r+1<s.length&&(n+="\n")):o=!1;o?e.replaceSelection(n,"around"):e.replaceSelection(i,"around")},wrapComments:function(e,t,s){var i=e.getSelection(),n="";n=this.wrappedInComments(i,t,s)?i.substring(t.length,i.length-s.length):t+i+s,e.replaceSelection(n,"around")},wrappedInComments:function(e,t,s){return e.substr(0,t.length)===t&&e.substr(-1*s.length,s.length)===s}},CMKeyBindings={handleKeydown:function(e,t){this._isTabKeyCombo(t)?this._handleTabOver(e):this._isCommentOutCodeKeyCombo(t)?e.somethingSelected()&&(this._commentOutCode(e),t.preventDefault()):this._isJoinLinesCombo(t)&&this._joinLines(e)},_isTabKeyCombo:function(e){return Keytrap.getKeyCode("tab")===e.keyCode},_isCommentOutCodeKeyCombo:function(e){return Keytrap.getKeyCode("/")===e.keyCode&&this._isCommandOrControlKey(e)},_isJoinLinesCombo:function(e){return e.keyCode===Keytrap.getKeyCode("j")&&this._isCommandOrControlKey(e)},_isCommandOrControlKey:function(e){return e.metaKey||e.ctrlKey},_handleTabOver:function(e){var t=TabSnippets.findSnippet(e);t&&this._applySnippetToEntireLine(e,t)},_applySnippetToEntireLine:function(e,t){var s=e.getCursor(),i={line:s.line,ch:0};e.replaceRange(t,i,s)},_commentOutCode:function(e){var t=TypesUtil.cmModeToType(e.getOption("mode"));CMComments.comment(e,t)},_joinLines:function(e){var t=e.getCursor();if(e.lineCount()-1>=t.line+1){var s=e.getLine(t.line)||"",i=e.getLine(t.line+1)||"",n=s+$.trim(i),o={line:t.line,ch:0},r={line:t.line+1,ch:i.length+1};e.replaceRange(n,o,r)}},_isHTMLMode:function(e){return"html"===TypesUtil.cmModeToType(e.getOption("mode"))}},Pen=Class.extend({id:"",title:"",description:"",slug_hash:"",html:"",css:"",js:"",parent:0,"private":!1,auto_run:!0,html_pre_processor:"none",html_classes:"",head:"",css_pre_processor:"none",css_pre_processor_lib:"",css_prefix:"neither",css_starter:"neither",css_external:"",js_pre_processor:"none",js_library:"",js_modernizr:!1,js_external:"",tags:[],autosave:!1,autosavingNow:!1,last_updated:"",errorCode:"",savingPenToDB:!1,saveAttempts:0,MAX_SAVE_ATTEMPTS:6,SAVE_ATTEMPT_TIMEOUT:1e4,fork:!1,lastSavedPen:{},redirectingToSavedURL:!1,init:function(){_.extend(this,AJAXUtil),this._loadStoredData(),this._ensureDataIsValid(),this._warnAboutLostChanges()},_loadStoredData:function(){_.extend(this,__pen,!0),this.tags=__tags,this.lastSavedPen=this._getLastSavedPenFromThisData()},_ensureDataIsValid:function(){var e=new PenValidator;e.makePenValid(this),e.makePenValid(this.lastSavedPen)},_warnAboutLostChanges:function(){var e=new PenSaver;e.warnAboutLostChanges(),this._shouldTurnOnAutosave()&&(this.autosave=!0,e.showAutoSaveOnMessage())},_shouldTurnOnAutosave:function(){var e=document.referrer||"";return"new-pen"===CPLocalStorage.removeItem(this.slug_hash)&&e.match(/\/pen(\/)?$/)},setPenValue:function(e){for(var t in e.pen)this._setValue(t,e.pen[t]);Hub.pub("pen-change",e)},_setValue:function(e,t){this[e]=t,this.last_updated=(new Date).getTime()},getLastUpdatedAt:function(){return this.last_updated},getActiveSlugHash:function(){return this.private?this.slug_hash_private:this.slug_hash},newPen:function(){window.location="/pen"},save:function(){this._canSave()?this._shouldForkPen()?this.forkPenInCurrentState():this.savePenToDB():Hub.pub("pen-errors",this.errorCode)},_shouldForkPen:function(){return!this.isUserPenOwner()},saveAsPrivate:function(){this._canSave()?(this.private=!0,this.savePenToDB()):Hub.pub("pen-errors",this.errorCode)},MAX_PEN_SIZE:1e6,_canSave:function(){return this.savingPenToDB?(this.errorCode="waiting-to-save-pen",!1):!CP.user.isUserLoggedIn()&&this._isPenConsideredEmpty()?(this.errorCode="anon-cannot-save-empty-pen",!1):!CP.user.isUserLoggedIn()&&this._isProfessorOrCollabSession()?(this.errorCode="anon-cannot-save-during-rt-session",!1):_lengthInUtf8Bytes(JSON.stringify(CP.pen))>this.MAX_PEN_SIZE?(this.errorCode="pen-too-large",!1):!0},_isProfessorOrCollabSession:function(){return"professor"===__pageType||"collab"===__pageType},forkPenInCurrentState:function(){this.fork=!0,this.savePenToDB()},savePenToDB:function(){if(this._shouldSavePenToDB()){this.savingPenToDB=!0;var e={pen:JSON.stringify(this)};this.post("/pen/save",e,this.doneSave,this.failedSave,this.erroredSave),this.fork=!1}else this.sendPseudoSavedSignal()},_shouldSavePenToDB:function(){return this.hasPenChanged()||!this._hasPenEverBeenSaved()||!this.isUserPenOwner()},sendPseudoSavedSignal:function(){Hub.pub("pen-saved",{})},doneSave:function(e){this.saveAttempts=0,this.savingPenToDB=!1;var t=this._getDiffPen(this,this.lastSavedPen);if(this.lastSavedPen=this._getLastSavedPenFromThisData(),e.new_pen_saved)if(this._isProfessorOrCollabSession()){var s={newPen:!0,url:e.redirect_url,pen:t};Hub.pub("pen-saved",s)}else CPLocalStorage.setItem(e.slug_hash,"new-pen"),this.redirectingToSavedURL=!0,window.location=e.redirect_url;else{var i={pen:t,last_saved_time_ago:e.last_saved_time_ago};Hub.pub("pen-saved",i)}},failedSave:function(e){this.savingPenToDB=!1,this.showStandardErrorMessage(e)},erroredSave:function(){if(this.savingPenToDB=!1,this.saveAttempts+=1,this.saveAttempts<this.MAX_SAVE_ATTEMPTS){var e=_.template(Copy.errors["unable-to-save-try-again"],{time:TimeUtil.countToString(this.saveAttempts)});$.showMessage(e,"super-slow"),setTimeout($.proxy(this.savePenToDB,this),this.SAVE_ATTEMPT_TIMEOUT)}else this.saveAttempts=0,$.showMessage(Copy.errors["unable-to-save-ever"],"super-slow")},isUserPenOwner:function(){return CP.profiled.is_team?CP.profiled.id===CP.user.current_team_id:CP.profiled.id===CP.user.id},_isPenConsideredEmpty:function(){return""===this.html&&""===this.css&&""===this.js},_hasPenEverBeenSaved:function(){return""!==this.slug_hash},hasPenChanged:function(){return _.size(this._getDiffPen(this,this.lastSavedPen))>0},_getDiffPen:function(e,t){return _diffObjects(t,e)},_getLastSavedPenFromThisData:function(){return _.pick(this,this.getDataRelevantAttributes())},getDataRelevantAttributes:function(){return["title","description","html","css","js","auto_run","html_pre_processor","html_classes","head","css_pre_processor","css_pre_processor_lib","css_prefix","css_starter","css_external","js_pre_processor","js_library","js_modernizr","js_external","tags","fork","private","parent"]},getAttributesThatAffectPenUI:function(){return["html","css","js","auto_run","html_pre_processor","html_classes","head","css_pre_processor","css_pre_processor_lib","css_prefix","css_starter","css_external","js_pre_processor","js_library","js_modernizr","js_external"]}}),PenDelete=Class.extend({init:function(){_.extend(this,AJAXUtil),this.profileURLs=__profileURLS,this._bindToDOM()},_bindToDOM:function(){$(".delete-button")._on("click",this._deletePen,this)},_deletePen:function(){$.showModal("/ajax/confirm_pen_delete","modal-warning",$.proxy(this._deletePenModalCallback,this))},_deletePenModalCallback:function(){$("#confirm-delete")._on("click",this._confirmDeletePen,this)},_confirmDeletePen:function(){this.del("/pen/"+CP.pen.slug_hash,{},this._doneDelete),$.showMessage(Copy.deletingPen,"super-slow")},_doneDelete:function(){window.location=CP.profiled.base_url+"/"+this._getProfilePageToReturnTo()+"/"},_getProfilePageToReturnTo:function(){var e="public",t=document.referrer.match(/(?:\/([^\/]+)\/?)$/);if(t){var s=t[1];_.contains(this.profileURLs,s)&&(e=s)}return e}}),PenSaver=Class.extend({liveChangesWOSave:0,autoSaveFunc:null,AUTOSAVE_TIMER:2e4,saveButton:$("#save, #update"),init:function(){this.user=__user,this.pageType=__pageType,this._bindToHub(),this.autoSaveFunc=_.debounce(this._saveViaAutoSave,this.AUTOSAVE_TIMER)},_bindToHub:function(){Hub.sub("live_change",$.proxy(this._onLiveChange,this)),Hub.sub("pen-saved",$.proxy(this._onSaved,this))},_onLiveChange:function(){this._shouldAutoSave()?this._handleAutoSave():this._handleNonAutoSave()},_shouldAutoSave:function(){return CP.pen.autosave&&1!==this.user.id},_handleAutoSave:function(){this.autoSaveFunc()},_saveViaAutoSave:function(){this._canAutoSaveNow()&&(CP.pen.autosavingNow=!0,CP.pen.save())},_canAutoSaveNow:function(){return CP.pen.hasPenChanged()&&!CP.infoController.showingInfoView()},_handleNonAutoSave:function(){return CP.pen.isUserPenOwner()?(this.liveChangesWOSave+=1,this.saveButton.removeClass("unsaved-wobble unsaved-grow"),6===this.liveChangesWOSave&&this.saveButton.addClass("unsaved-wobble"),11===this.liveChangesWOSave&&this.saveButton.addClass("unsaved-grow"),16===this.liveChangesWOSave&&$.showMessage("There have been 15 changes without a save. Remember to save your work!","slow"),void(21===this.liveChangesWOSave&&this.saveButton.addClass("unsaved-wobble"))):!1},_onSaved:function(){return CP.pen.autosave?!0:(CP.pen.autosave=!0,void this.showAutoSaveOnMessage())},showAutoSaveOnMessage:function(){setTimeout(function(){$.showMessage(Copy.autoSavingNow,"slow")},1500)},warnAboutLostChanges:function(){window.onbeforeunload=$.proxy(function(){return this._shouldWarnAboutLostWork()?Copy.youHaveUnsavedChanges:void 0},this)},_shouldWarnAboutLostWork:function(){var e=CP.pen.hasPenChanged();return"professor"===this.pageType?e&&this._isProfessorInProfessorRoom():"collab"===this.pageType?e&&this._isPenOwnerInCollabRoom():e&&!CP.pen.redirectingToSavedURL},_isProfessorInProfessorRoom:function(){var e=!1;return"professor"===this.pageType&&"undefined"!=typeof CP.professor&&(e=!0),e},_isPenOwnerInCollabRoom:function(){return"collab"===this.pageType?CP.pen.isUserPenOwner():!1}}),LocalDataValidator={makeObjValid:function(e,t){for(var s in e)t[s]&&(e[s]=this._getValidAttributeValue(t,s,e[s]))},_getValidAttributeValue:function(e,t,s){var i=e[t];return _.isArray(i["typeof"])?this._getValidArrayAttributeValue(s,i):this._getValidSimpleAttributeValue(s,i)},_getValidArrayAttributeValue:function(e,t){return _.contains(t["typeof"],e)?e:t["default"]},_getValidSimpleAttributeValue:function(e,t){return typeof e===t["typeof"]?e:t["default"]}},PenValidator=Class.extend({dataAttributes:{title:{"typeof":"string","default":""},description:{"typeof":"string","default":""},slug_hash:{"typeof":"string","default":""},html:{"typeof":"string","default":""},css:{"typeof":"string","default":""},js:{"typeof":"string","default":""},parent:{"typeof":"number","default":0},"private":{"typeof":"boolean","default":!1},auto_run:{"typeof":"boolean","default":!0},html_pre_processor:{"typeof":["none","haml","markdown","slim","jade"],"default":"none"},html_classes:{"typeof":"string","default":""},head:{"typeof":"string","default":""},css_pre_processor:{"typeof":["none","sass","scss","less","stylus"],"default":"none"},css_pre_processor_lib:{"typeof":"string","default":""},css_prefix:{"typeof":["neither","autoprefixer","prefixfree"],"default":"neither"},css_starter:{"typeof":["neither","normalize","reset"],"default":"neither"},css_external:{"typeof":"string","default":""},js_pre_processor:{"typeof":["none","coffeescript","livescript","traceur"],"default":"none"},js_library:{"typeof":["","jquery","jquery_and_jqueryui","zepto","angular","mootools","prototype","yui","extjs","dojo"],"default":""},js_modernizr:{"typeof":"boolean","default":!1},js_external:{"typeof":"string","default":""}},init:function(){},makePenValid:function(e){LocalDataValidator.makeObjValid(e,this.dataAttributes)}}),Profiled=Class.extend({init:function(){_.extend(this,__profiled)},isUserProfiled:function(e){return this.is_team?!1:e.username===this.username}}),UI={buildDefaultUIData:function(){return{info:"closed",layout:window.__layoutType,editorViewSource:{html:!1,css:!1,js:!1},scrollTopLine:{html:{},css:{},js:{}},textSelection:{html:{start:{line:0,ch:0,xRel:0},end:{line:0,ch:0,xRel:0}},css:{start:{line:0,ch:0,xRel:0},end:{line:0,ch:0,xRel:0}},js:{start:{line:0,ch:0,xRel:0},end:{line:0,ch:0,xRel:0}}},editorSizes:{html:"open",css:"open",js:"open"},externalInputs:{html:0,css:1,js:1},settingsPanes:{html:"closed",css:"closed",js:"closed"}}}},User=Class.extend({init:function(){_.extend(this,__user)},isUserLoggedIn:function(){return+this.id>1}}),InfoController=Class.extend({init:function(){this.model=new InfoModel,this.events=new InfoEvents(this),this.view=new InfoView(this.model)},syncWithServer:function(e){this.model.syncWithServer(e)},toggle:function(e){this.model.toggle(e)},hide:function(e){this.model.hide(e)},hideOnly:function(){this.view.hideOnly()},showingInfoView:function(){return this.view.infoViewVisible()},savePen:function(){CP.pen.save()},savePenAsPrivate:function(){CP.pen.saveAsPrivate()},fork:function(){CP.pen.forkPenInCurrentState()},runPen:function(){CP.penRenderer.processAndRender()},setTitle:function(e){CP.pen.setPenValue(e)},setDescription:function(e){CP.pen.setPenValue(e)},setPenPrivacy:function(e){CP.pen.setPenValue(e)}}),InfoEvents=Class.extend({$body:$("body"),$saveDetailsButton:$("#save-details"),$title:$("#pen-details-title"),$description:$("#pen-details-description"),$privateCkbx:$("#pen-details-private"),$penTags:$("#pen-tags"),MAX_TAGS:5,savedTags:[],_tagsWaitingToBeDeleted:[],init:function(e){this.controller=e,this.savedTags=CP.pen.tags.slice(0),this._bindToDOM(),this._bindToHub()},_bindToHub:function(){Hub.sub("key",$.proxy(this._onKey,this)),Hub.sub("pen-saved",$.proxy(this._onPenSaved,this)),Hub.sub("server-ui-change",$.proxy(this._onServerUIChange,this))},_onPenSaved:function(){this._updateTagsOnSave()},_onServerUIChange:function(e,t){"info"in t.ui&&this.controller.syncWithServer(t)
},_bindToDOM:function(){$("#edit-details")._on("click",this._toggle,this),$(".edit-details-reminder")._on("click",this._toggle,this),_hideElementWhenUserClicksAway("#pen-details",$.proxy(this._hide,this)),$("#pen-details-title").on("keyup",$.proxy(this._setTitle,this)),$("#pen-details-description").on("keyup",$.proxy(this._setDescription,this)),$("#pen-details-private")._on("click",this._setPenPrivacy,this,!0),this.$body.on("click","#active-tags span span.tag-x",$.proxy(this._handleTagDelete,this)),this.$penTags._on("keyup",this._onTagChange,this),$("#save, #update")._on("click",this._savePen,this),$("#save-as-private")._on("click",this._savePenAsPrivate,this),$("#pen-details-form")._on("submit",this._savePen,this),$("#fork")._on("click",this._fork,this),$("#run")._on("click",this._runPen,this)},_onKey:function(e,t){"esc"===t.key&&this._hide()},_hide:function(){var e={origin:"client"};this.controller.hide(e)},_toggle:function(){var e={origin:"client"};this.controller.toggle(e)},_savePen:function(){this.controller.savePen()},_savePenAsPrivate:function(){this.controller.savePenAsPrivate()},_fork:function(){this.controller.fork()},_runPen:function(){this.controller.runPen()},_setTitle:function(){var e={origin:"client",pen:{title:this.$title.val()}};this.controller.setTitle(e)},_setDescription:function(){var e={origin:"client",pen:{description:this.$description.val()}};this.controller.setDescription(e)},_setPenPrivacy:function(){var e={origin:"client",pen:{"private":this.$privateCkbx.is(":checked")}};this.controller.setPenPrivacy(e)},_onTagChange:function(){var e=this.without(this.savedTags,this._tagsWaitingToBeDeleted),t=this.getSavedAndUnsavedTags(e);this._updateTagHTML(t,e),CP.pen.setPenValue({origin:"client",pen:{tags:t}})},getSavedAndUnsavedTags:function(e){for(var t=e.slice(0),s=_stripHTMLTags(this.$penTags.val()).split(","),i=0;i<s.length;i++){var n=$.trim(s[i]);if(n&&t.push(n.toLowerCase()),t.length>=this.MAX_TAGS){$("#max-tags-label").addClass("at-capacity");break}$("#max-tags-label").removeClass("at-capacity")}return _.uniq(t)},_updateTagHTML:function(e,t){var s=this._getTagHTML(e,t);$("#active-tags").html(s)},_getTagHTML:function(e,t){for(var s="",i=0;i<e.length;i++)if(e[i]){var n=t.indexOf(e[i])>-1?"saved_tag":"";s+="<span class='tag '"+n+">",s+="<span class='tag-x'>\xd7</span> ",s+="<span class='tag-name'>"+e[i]+"</span> ",s+="</span> "}return s},_handleTagDelete:function(e){e.preventDefault();var t=$(e.target),s=$.trim(t.next().html());return t.parent().remove(),this.updateTagAfterDeletion(s),!1},updateTagAfterDeletion:function(e){this._tagsWaitingToBeDeleted.push(e);var t=this.without(this.savedTags,this._tagsWaitingToBeDeleted);CP.pen.setPenValue({origin:"client",pen:{tags:t}})},without:function(e,t){var s=[];return $.each(e,function(e,i){-1===t.indexOf(i)&&s.push(i)}),s},_updateTagsOnSave:function(){this.$penTags.val(""),this._tagsWaitingToBeDeleted=[],this.savedTags=CP.pen.tags.slice(0),this._updateTagHTML(this.savedTags,this.savedTags)}}),InfoModel=Class.extend({CLOSED:"closed",OPEN:"open",init:function(){this.pageType=__pageType},toggle:function(e){CP.ui.info=CP.ui.info===this.CLOSED?this.OPEN:this.CLOSED,this._pubUIChange(e)},isOpen:function(){return CP.ui.info===this.OPEN},hide:function(e){CP.ui.info=this.CLOSED,this._pubUIChange(e)},syncWithServer:function(e){CP.ui.info=e.ui.info,this._pubUIChange(e)},_pubUIChange:function(e){var t={origin:e.origin,ui:{info:CP.ui.info}};Hub.pub("ui-change",t)}}),InfoView=Class.extend({$body:$("body"),$saveDetailsButton:$("#save-details"),$showInfoViewPane:$("#pen-details"),$showInfoViewTitle:$("#pen-details-title"),$lastSavedTimeAgo:$("#last-saved-time-ago"),$detailsTitle:$("#details-title"),init:function(e){this.pageType=__pageType,this.model=e,this._bindToHub()},_bindToHub:function(){Hub.sub("ui-change",$.proxy(this._onUIChange,this)),Hub.sub("pen-saved",$.proxy(this._onPenSaved,this)),Hub.sub("pen-change",$.proxy(this._onPenChange,this)),Hub.sub("pen-errors",$.proxy(this._onPenErrors,this))},infoViewVisible:function(){return this.$showInfoViewPane.is(":visible")},_onUIChange:function(e,t){"info"in t.ui&&this._updateInfoView(t.ui.info)},_updateInfoView:function(e){$.hideMessage(),CP.shareView.hideShareView(),e===this.model.OPEN?this._showInfoView():this._hideInfoView()},_showInfoView:function(){this.$showInfoViewTitle.focus(),this.$showInfoViewPane.slideDown(100),this.$showInfoViewTitle.focus()},_hideInfoView:function(){this.$showInfoViewPane.slideUp(100)},hideOnly:function(){this._hideInfoView()},_onPenChange:function(e,t){this._showPenHasUnsavedChanges(),"title"in t.pen&&(document.title=t.pen.title,this.$detailsTitle.html(t.pen.title)),"private"in t.pen&&this._updateBrowserURL()},_showPenHasUnsavedChanges:function(){this.$body.addClass("unsaved"),this.$saveDetailsButton.attr("disabled",!1)},_hidePenHasUnsavedChanges:function(){this.$body.removeClass("unsaved"),this.$saveDetailsButton.attr("disabled",!0)},_updateBrowserURL:function(){if(window.history.replaceState){var e=URLBuilder.getViewURL(this.pageType,CP.profiled,CP.pen,!1);window.history.replaceState(e,"",e)}},_onPenErrors:function(e,t){$.showMessage(Copy.errors[t],"slow")},_onPenSaved:function(e,t){this._isNewPenInProfessorOrCollab(t)?$.showMessage(_.template(Copy.penForked,t),8e3):(CP.pen.autosavingNow||$.showMessage(Copy.penUpdated),CP.pen.autosavingNow=!1,this._hidePenHasUnsavedChanges(),this._shouldHideInfoView(t)&&this._hideInfoView(),this._updateTabs(),this._updateSavedTimeAgoFooter())},_isNewPenInProfessorOrCollab:function(e){return _.contains(["professor","collab"],this.pageType)&&e.newPen},_shouldHideInfoView:function(e){return!e.pen||"private"in e.pen?!1:!0},_updateTabs:function(){"details"===this.pageType&&window.location.reload()},_updateSavedTimeAgoFooter:function(){this.$lastSavedTimeAgo.html(CP.pen.last_saved_time_ago)}}),KeyBindings=Class.extend({$overlay:$("#overlay"),$keyCommands:$("#keycommands"),$keyCommandsButton:$(".keyboard-commands-button"),init:function(){this._bindToDOM(),this._bindToKeyCombos(),this._bindToCodeMirrorCommands()},_bindToCodeMirrorCommands:function(){"vim"===__keyBindings&&(CodeMirror.commands.save=function(){CP.pen.save()})},_bindToDOM:function(){_hideElementWhenUserClicksAway("#keycommands",$.proxy(this.hideKeyCommandsModal,this)),this.$keyCommandsButton._on("click",$.proxy(this.toggleKeyCommandsModal,this)),this.$overlay.on("click",$.proxy(this.hideKeyCommandsModal,this))},toggleKeyCommandsModal:function(){this.$keyCommands.toggle(),this.$overlay.toggle()},showKeyCommandsModal:function(){this.$keyCommands.show(),this.$overlay.show()},hideKeyCommandsModal:function(){this.$keyCommands.hide(),this.$overlay.hide()},triggerKeyEvent:function(e){Keytrap.trigger({},e)},_bindToKeyCombos:function(){Keytrap.bind("esc",function(){$.hideMessage(),Hub.pub("key",{key:"esc"})},!0),Keytrap.bind("comctrl+e",function(){$("#new-comment").focus()},!0),Keytrap.bind("comctrl+s",function(){CP.pen.save()},!0),Keytrap.bind("comctrl+shift+s",function(){CP.pen.saveAsPrivate()},!0),Keytrap.bind("comctrl+p",function(){CP.pen.newPen()},!0),Keytrap.bind("comctrl+shift+5",function(){CP.penRenderer.processAndRenderWithFullRefresh()},!0),Keytrap.bind("comctrl+shift+0",function(){if(CP.pen.slug_hash){var e=document.location.href.replace("/pen/","/full/");window.open(e)}},!0),Keytrap.bind("comctrl+shift+9",function(){$.hideMessage(),KeyBindings.showKeyCommandsModal()},!0),Keytrap.bind("comctrl+i",function(){CP.infoController.toggle()},!0),Keytrap.bind("comctrl+shift+.",function(){CP.htmlEditor.hasFocus()&&CP.htmlEditor.editor.execCommand("closeTag")},!0)}}),__snippet_html={mode:"html",type:"html",snippets:{lorem:"<p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo.</p>",nav:'<nav role=\'navigation\'>\n  <ul>\n    <li><a href="#">Home</a></li>\n    <li><a href="#">About</a></li>\n    <li><a href="#">Clients</a></li>\n    <li><a href="#">Contact Us</a></li>\n  </ul>\n</nav>',ul:"<ul>\n  <li>Lorem ipsum dolor sit amet, consectetuer adipiscing elit.</li>\n  <li>Aliquam tincidunt mauris eu risus.</li>\n  <li>Vestibulum auctor dapibus neque.</li>\n</ul>",ol:"<ol>\n  <li>Lorem ipsum dolor sit amet, consectetuer adipiscing elit.</li>\n  <li>Aliquam tincidunt mauris eu risus.</li>\n  <li>Vestibulum auctor dapibus neque.</li>\n</ol>",form:'<form action="#">\n  <div>\n    <label for="name">Text Input:</label>\n    <input type="text" name="name" id="name" placeholder="John Smith" />\n  </div>\n\n  <fieldset>\n    <legend>Radio Button Choice</legend>\n\n    <label for="radio-choice-1">Choice 1</label>\n    <input type="radio" name="radio-choice" id="radio-choice-1" value="choice-1" />\n\n    <label for="radio-choice-2">Choice 2</label>\n    <input type="radio" name="radio-choice" id="radio-choice-2" value="choice-2" />\n  </fieldset>\n\n  <div>\n    <label for="select-choice">Select Dropdown Choice:</label>\n    <select name="select-choice" id="select-choice">\n      <option value="Choice 1">Choice 1</option>\n      <option value="Choice 2">Choice 2</option>\n      <option value="Choice 3">Choice 3</option>\n    </select>\n  </div>\n\n  <div>\n    <label for="textarea">Textarea:</label>\n    <textarea cols="40" rows="8" name="textarea" id="textarea"></textarea>\n  </div>\n\n  <div>\n    <label for="checkbox">Checkbox:</label>\n    <input type="checkbox" name="checkbox" id="checkbox" />\n  </div>\n\n  <div>\n    <input type="submit" value="Submit" />\n  </div>\n</form>',select:"<select name='options'>\n  <option value='option-1'>Option 1</option>\n  <option value='option-2'>Option 2</option>\n  <option value='option-3'>Option 3</option>\n</select>"}},__snippet_css={mode:"css",type:"css",snippets:{phark:".element {\n  text-indent: -9999px;\n  display: block;\n  width: px;\n  height: px;\n  background: url() no-repeat;\n}"}},__snippet_js={mode:"js",type:"js",snippets:{"for":"for (var i = 0; i < Things.length; i++) {\n  Things[i];\n}"}},TabSnippets={snippets:{html:{},css:{},js:{}},loadSnippet:function(e){var t=this.getPreProcessorType(e);if(this._alreadyLoadedSnippet(t))return 0;if("undefined"==typeof this.snippets[e][t]&&t){var s="/assets/editor/other/snippets/"+t+".js";_getCachedScript(s,function(){TabSnippets.snippets[e][t]=window["__snippet_"+t].snippets})}},_alreadyLoadedSnippet:function(e){return _.contains(["html","css","js"],e)},findSnippet:function(e){var t=this.getMode(e),s=this.getPreProcessorType(t),i=e.getCursor(),n=e.getLine(i.line),o=$.trim(n.substring(0,i.ch));if("undefined"!=typeof this.snippets[t][s])for(var r in this.snippets[t][s])if($.trim(o)===r)return this.snippets[t][s][r];return!1},getMode:function(e){return TypesUtil.cmModeToType(e.getOption("mode"))},getPreProcessorType:function(e){var t=CP.pen[e+"_pre_processor"];return"none"===t?e:t}},ClientSidePenValidations={validate:function(e,t){return this.validateHTML(e,t),this.validateCSS(e,t),t},validateHTML:function(e,t){var s=/^(\s+)?<!doctype/i;s.test(e.html)&&(t.html={line:1,type:"html",message:"You don't need a DOCTYPE on CodePen. Just put here what you would normally put in the <body>.",level:"warn",pretty_name:"HTML"})},validateCSS:function(e,t){if(_.contains(["scss","sass"],e.css_pre_processor)){var s=/inline-image/i;s.test(e.css)&&(t.css={line:this._findErrorLineNumber(e.css,s),type:"css",message:'The function inline-image can not be used on CodePen since it depends on reading images from disk. We"ve removed it.',level:"warn",pretty_name:"SCSS"});var i=/image-width\(/i;i.test(e.css)&&(t.css={line:this._findErrorLineNumber(e.css,i),type:"css",message:'The function image-width can not be used on CodePen since it depends on reading images from disk. We"ve removed it.',level:"warn",pretty_name:"SCSS"});var n=/image-height\(/i;n.test(e.css)&&(t.css={line:this._findErrorLineNumber(e.css,n),type:"css",message:'The function image-height can not be used on CodePen since it depends on reading images from disk. We"ve removed it.',level:"warn",pretty_name:"SCSS"})}if("less"===e.css_pre_processor){var o=/data-uri/i;o.test(e.css)&&(t.css={line:this._findErrorLineNumber(e.css,o),type:"css",message:'The function data-uri can not be used because it"s insecure. We"ve removed it from your LESS code.',level:"warn",pretty_name:"LESS"})}return t},_findErrorLineNumber:function(e,t){for(var s=e.split("\n"),i=0,n=s.length;n>i;i++)if(t.test(s[i]))return i+1;return 1}},Instrument={init:function(){var e="while (true) { if (window.CP.shouldStopExecution(1)) { break; }}",t=esprima.parse(e);this.loopPrependAST=t.body[0].body.body[0];var s="window.CP.exitedLoop(1);",i=esprima.parse(s);this.exitedAppendAST=i.body[0]},js:function(e,t){try{e=e||"";var s={id:0},i={tolerant:!0},n=esprima.parse(e,i);if(this._shouldInstrumentJS(e)){var o=this._insertStopExecutionOnTimeoutCallsToAST(n,s);return escodegen.generate(o)}return e}catch(r){return t.js={line:r.lineNumber,column:r.column,index:r.index,type:"js",message:r.description,level:"error",pretty_name:"JavaScript"},e}},_shouldInstrumentJS:function(e){return!e.match(/(requestAnimationFrame|setInterval)/i)},_insertStopExecutionOnTimeoutCallsToAST:function(e,t){var s,i;if(null===e)return!1;for(var n in e)if(!this._skipThisAttribute(n)&&"object"==typeof e[n])if(_.isArray(e[n]))for(s=0,i=e[n].length;i>s;s++)this._insertStopExecutionOnTimeoutCallsToAST(e[n][s],t),this._isLoopType(e[n][s].type)&&this._appendExitedLoop(e,t,s);else this._insertStopExecutionOnTimeoutCallsToAST(e[n],t),e[n]&&this._isLoopType(e[n].type)&&this._appendExitedLoop(e,t,0);if(this._hasLoopToInstrument(e)&&("BlockStatement"===e.body.type&&this._prependStopExecutionTimeoutToBlockStatement(e,t),"ExpressionStatement"===e.body.type)){var o=this._clone(e.body);e.body={type:"BlockStatement",body:[o]},this._prependStopExecutionTimeoutToBlockStatement(e,t)}return e},_hasLoopToInstrument:function(e){return this._isLoopType(e.type)&&e.body?!0:!1},_skipThisAttribute:function(e){var t=["id","params","defaults","left","computed","object","rest","generator","property","callee","operator","prefix","test","kind","raw","value"];return t.indexOf(e)>-1?!0:!1},_prependStopExecutionTimeoutToBlockStatement:function(e,t){if(e.body&&e.body.body){var s=this._clone(this.loopPrependAST);this._updateArgumentsWithLoopID(e,s,t),e.body.body.unshift(s)}},_updateArgumentsWithLoopID:function(e,t,s){s.id+=1,this._isLoopType(e.type)?t.test.arguments=[{type:"Literal",value:s.id,raw:s.id}]:t.expression.arguments=[{type:"Literal",value:s.id,raw:s.id}]},_appendExitedLoop:function(e,t,s){if(_.isArray(e.body)){var i=this._clone(this.exitedAppendAST);i.expression.arguments=[{type:"Literal",value:t.id,raw:t.id}],0===s?e.body.push(i):e.body.splice(s+1,0,i)}},_isLoopType:function(e){var t=["WhileStatement","DoWhileStatement","ForStatement","ForInStatement","ForOfStatement"];return t.indexOf(e)>-1},_clone:function(e){return JSON.parse(JSON.stringify(e))}},PenErrorHandler=Class.extend({editorErrorData:{},init:function(){this.initEditorErrorData(),this.bindToElements(),this._bindToHub()},initEditorErrorData:function(){_.each(["html","css","js"],function(e){this.editorErrorData[e]={preprocErrors:[],preprocErrorLineNums:[]}},this)},bindToElements:function(){$(".editor-parent").on("click",".error-icon",$.proxy(this.toggleSingleInlineError,this))},_bindToHub:function(){Hub.sub("error-in-code",$.proxy(this._onErrorInCode,this))},toggleSingleInlineError:function(e){var t=$(e.target).closest("div.box").data("type");$("#box-"+t+" .inline-editor-error").removeClass("inline-error-hidden"),t=$(e.target).data("type"),this.jumpToFirstError(t),this.hideErrorBar(t),Hub.pub("editor-refresh",{delay:0})},_onErrorInCode:function(e,t){this.handleErrorsInEditor(t)},canStillRenderPen:function(e){var t=!0;for(var s in e){var i=e[s];if("error"===i.level){t=!1;break}}return t},previousShowErrorsInEditorTimeoutID:0,handleErrorsInEditor:function(e){this.clearPreviousCallToEditorErrors(),this.clearPreprocWidgets("all"),_.size(e)&&this.showErrorsInEditor(e)},clearPreviousCallToEditorErrors:function(){clearTimeout(this.previousShowErrorsInEditorTimeoutID)},clearPreprocWidgets:function(e){"all"===e?_.each(["html","css","js"],function(e){this.clearPreprocWidgetsOfType(e)},this):this.clearPreprocWidgetsOfType(e),this.hideErrorBar()},clearPreprocWidgetsOfType:function(e){for(var t=CodeEditorsUtil.getEditorByType(e),s=this.editorErrorData[e].preprocErrors,i=this.editorErrorData[e].preprocErrorLineNums,n=0,o=s.length;o>n;n++){s[n].clear();var r=i[n]-1;t.editor.removeLineClass(r,"background","line-highlight")}this.editorErrorData[e].preprocErrors=[],this.editorErrorData[e].preprocErrorLineNums=[]},showErrorsInEditor:function(e){this.previousShowErrorsInEditorTimeoutID=setTimeout($.proxy(function(){this.showPreprocessorErrors(e)},this),this.inlineErrorTimeout)},showPreprocessorErrors:function(e){for(var t in e){var s=TypesUtil.syntaxToType(t);CP.penRenderer.setPostProcessed(s,"");var i=CodeEditorsUtil.getEditorByType(s),n=e[t],o=this.addInlineEditorWidget(i.editor,n.line,n.message);this.editorErrorData[s].preprocErrors.push(o),this.editorErrorData[s].preprocErrorLineNums.push(n.line),this.showErrorBar(s)}},addInlineEditorWidget:function(e,t,s){var i="<div class='inline-editor-error inline-error-hidden'><div class='inline-error-message'><%= message %></div></div>",n=_htmlEntities(s),o=_.template(i,{message:n}),r=$(o)[0],a=parseInt(t-1,10);e.addLineClass(a,"background","line-highlight");var l={coverGutter:!0,noHScroll:!0};return e.addLineWidget(a,r,l)},jumpToFirstError:function(e){var t=this.editorErrorData[e].preprocErrorLineNums,s=this.getErrorLineNumberToScrollTo(t[0]);CodeEditorsUtil.getEditorByType(e).editor.scrollIntoView(s)},getErrorLineNumberToScrollTo:function(e){return e-2>0?e-2:0},showErrorBar:function(e){$("#error-bar-"+e).show()},hideErrorBar:function(e){e?$("#error-bar-"+e).hide():$(".error-bar").hide()},editorHasErrors:function(e){return this.editorErrorData[e].preprocErrors.length}}),BunkerBox={makeHeadSafe:function(e,t){return e=e||"",t=this._getSafeSandboxType(t),"public"===t&&(e=e.replace(/<script.+/gim,"")),e=this.makeHTMLSafe(e,t)},makeHTMLSafe:function(e,t){return e=e||"",t=this._getSafeSandboxType(t),e=e.replace(/(<.*?\s)(autofocus=("|')autofocus("|')|autofocus)/g,"$1"),e=e.replace(/src=.+(&#)/gim,""),e=e.replace(/autoPlay=true/gim,"autoPlay=false"),e=e.replace(/http-equiv="refresh"/gim,""),"public"===t&&(e=this._makeHTMLSafeForPublic(e)),e=this.makeJSSafe(e,t)},_makeHTMLSafeForPublic:function(e){var t=e.replace(/(\s+)(action=)("|")([\S]+)("|")/gim,"$1$2$3#$5");return t},makeJSSafe:function(e,t){return e=e||"",t=this._getSafeSandboxType(t),e=e.replace(/location\.replace/gim,""),e=e.replace(/location\.reload/gim,""),"public"===t&&(e=e.replace("beforeunloadreplacedbycodepen"),e=e.replace(/debugger(\s+)?;/gim,""),e=e.replace(/alert/gim,""),e=e.replace(/geolocation/gim,"")),this._isSandboxSupported()||(e=e.replace(/window(\s+)?\[(\s+)?("|")l/gim,""),e=e.replace(/self(\s+)?\[(\s+)?("|")loc/gim,""),e=e.replace(/\.submit\(\)/gim,""),e=e.replace(/fromCharCode/gim,""),e=e.replace(/\blocation(\s+)?=/gim,"")),e},_getSafeSandboxType:function(e){return"undefined"==typeof e?"public":"public"===e?"public":"personal"},_sandboxSupported:null,_isSandboxSupported:function(){return null===this._sandboxSupported&&(this._sandboxSupported=this._determineIfSanboxIsSupported()),this._sandboxSupported},_determineIfSanboxIsSupported:function(){try{return"sandbox"in document.createElement("iframe")}catch(e){return!1}}},IFramePenToHTML={renderPenAsHTML:function(e){var t=[];return t.push(this.getHTMLStart(e)),t.push(this.getHeadAndCSS(e)),t.push(this.getHTML(e)),t.push(this.getJS(e)),t.push(this._getCSSLiveReloadJS()),t.push(this.getHTMLEnd()),t.join("\n")},getHTMLStart:function(e){return"<!DOCTYPE html><html class='"+e.html_classes+"'>"},getHTMLEnd:function(){return"</body></html>"},getHeadAndCSS:function(e){var t="<head><meta charset='UTF-8'>";t+='<meta name="robots" content="noindex">',t+='<link rel="canonical" href="'+document.location.href+'" />',t+="\n"+e.head+"\n","normalize"===e.css_starter?t+="<link rel='stylesheet' href='http://s.codepen.io/assets/reset/normalize.css'>":"reset"===e.css_starter&&(t+="<link rel='stylesheet' href='http://s.codepen.io/assets/reset/reset.css'>"),"jquery_and_jqueryui"===e.js_library&&(t+="<link rel='stylesheet' href='//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css'>"),"prefixfree"===e.css_prefix&&(t+="<script src='http://s.codepen.io/assets/libs/prefixfree.min.js'></script>"),e.js_modernizr&&(t+="<script src='http://s.codepen.io/assets/libs/modernizr.js'></script>");for(var s=0;s<e.resources.length;s++){var i=e.resources[s];"include_css_url"===i.action?_isValidURL(i.url)&&(t+="<link rel='stylesheet prefetch' href='"+i.url+"'>"):"prepend_as_css"===i.action&&(t+="\n<style>"+i.content+"</style>")}return t+='\n<style class="cp-pen-styles">'+e.css+"</style>",t+="</head><body>"},getHTML:function(e){return BunkerBox.makeHTMLSafe(e.html,"personal")},_getCSSLiveReloadJS:function(){return"<script src='"+this._getBaseDomain()+"/assets/editor/live/css_live_reload_init.js'></script>"},_getBaseDomain:function(){var e=document.location;return e.protocol+"//"+e.host},getJS:function(e){return this._isIE9()?this._getJSScripts(e)+"\n<script>setTimeout(function() {"+this.getSafeJS(e.js)+"}, 0);</script>":this._getJSScripts(e)+this._getPenJS(e)},_getPenJS:function(e){var t=this.getSafeJS(e.js);return t?"\n<script>\n"+t+"\n//@ sourceURL=pen.js\n</script>":""},_getJSScripts:function(e){var t="";return"none"!==e.js_library&&""!==e.js_library&&(t+=this._getCommonJSScripts(e.js_library)),"traceur"===e.js_pre_processor&&(t+="<script src='/assets/libs/traceur-runtime.js'></script>"),this._includeStopExecutionScript(e)&&(t+="<script src='/assets/common/stopExecutionOnTimeout.js?t=1'></script>"),t+=this._getPenResourcesAsScripts(e.resources)},_includeStopExecutionScript:function(e){return e.js.match(/shouldStopExecution/)},_getCommonJSScripts:function(e){var t={jquery:"//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js",jquery_and_jqueryui:"//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js",angular:"//ajax.googleapis.com/ajax/libs/angularjs/1.3.2/angular.min.js",zepto:"//cdnjs.cloudflare.com/ajax/libs/zepto/1.0/zepto.min.js",mootools:"//ajax.googleapis.com/ajax/libs/mootools/1.4.5/mootools-yui-compressed.js",prototype:"//ajax.googleapis.com/ajax/libs/prototype/1.7.1/prototype.js",yui:"//yui.yahooapis.com/3.10.3/build/yui/yui-min.js",extjs:"//cdn.sencha.io/ext-4.2.0-gpl/ext-all.js",dojo:"//ajax.googleapis.com/ajax/libs/dojo/1.9.0/dojo/dojo.js"},s="";return t[e]&&("jquery_and_jqueryui"===e&&(s+="<script src='//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js'></script>"),s+=t[e]?"<script src='"+t[e]+"'></script>":""),s},_getPenResourcesAsScripts:function(e){for(var t="",s=0,i=e.length;i>s;s++)"include_js_url"===e[s].action?t+="<script src='"+e[s].url+"'></script>":"prepend_as_js"===e[s].action&&(t+="\n<script>"+e[s].content+"</script>");return t},_isIE9:function(){var e=function(){for(var e,t=3,s=document.createElement("div"),i=s.getElementsByTagName("i");s.innerHTML="<!--[if gt IE "+ ++t+"]><i></i><![endif]-->",i[0];);return t>4?t:e}();return 9===e},getSafeJS:function(e){return BunkerBox.makeJSSafe(e,"personal")}},IFrameRenderer={penHTMLKey:"",activeIFrameID:"",penHTML:"",resultDiv:$("#result_div"),init:function(){this.penHTMLPrefix=__phkPrefix,this.sandboxVal=__sandboxVal,this.figureOutLayout(),this._listenToPostMessages(),_.extend(this,AJAXUtil)},_listenToPostMessages:function(){var e=this;window[this._eventMethod()](this._messageEvent(),function(t){try{var s=JSON.parse(t.data),i=e._findRealLineNumber(s.line);Hub.pub("error-in-code",{js:{line:i,type:"js",message:e._getNiceMessageAboutInfiniteLoop(i),level:"error",pretty_name:"JavaScript"}})}catch(n){}},!1)},_messageEvent:function(){return"attachEvent"===this._eventMethod()?"onmessage":"message"},_eventMethod:function(){return window.addEventListener?"addEventListener":"attachEvent"},_findRealLineNumber:function(e){var t=this._findLineInRenderedPenHTML(e);t=t.replace(/\s+/g,"");var s=_.map(CP.pen.js.split(/\r\n?|\n/),function(e){return e.replace(/\s+/g,"")});return _.indexOf(s,t)+1},_findLineInRenderedPenHTML:function(e){for(var t=this.penHTML.split(/\r\n?|\n/),s=e;s>-1&&t[s].match(/(break;|shouldStopExecution)/);)s-=1;return t[s]},_getNiceMessageAboutInfiniteLoop:function(e){return"Infinite loop found on line "+e+". The line number is approximated so look carefully."},figureOutLayout:function(){this.layoutStyle=$("body").hasClass("layout-right")||$("body").hasClass("layout-left")?"side":"top"},UPDATE_LIVE_IFRAME_TIMEOUT:400,ACTIVE_LIVE_IFRAME_TIMEOUT:5,lastUpdateLiveIFrameSetTimeoutID:0,updateLiveIFrame:function(e){navigator.cookieEnabled?this._updateCSSOnly(e)?this._sendUpdateCSSOnlyMessage(e):this._standardUpdateLiveIFrame(e):this._disabledCookiesUpdateIFrame()},prevPen:null,_updateCSSOnly:function(e){if(this._hasCSSThatNeedsAFullRefresh(e))return!1;if(!e.auto_run)return!1;if(e.fullRefresh)return!1;var t=this._hasOnlyCSSChanges(e,this.prevPen);return this.prevPen=_.clone(e,!0),t},_hasCSSThatNeedsAFullRefresh:function(e){var t=e.css||"";return t.match(/keyframes/gi)||t.match(/:target/gi)},_hasOnlyCSSChanges:function(e,t){if(null===t)return!1;var s=_diffObjects(e,t);return delete s.css,0===_.size(s)},_sendUpdateCSSOnlyMessage:function(e){var t=document.getElementById("result"+this.penHTMLKey);t.contentWindow.postMessage(JSON.stringify(e),"*")},_standardUpdateLiveIFrame:function(e){clearTimeout(this.lastUpdateLiveIFrameSetTimeoutID),this.lastUpdateLiveIFrameSetTimeoutID=setTimeout($.proxy(function(){this._runLiveUpdate(e),this.ACTIVE_LIVE_IFRAME_TIMEOUT=this.UPDATE_LIVE_IFRAME_TIMEOUT},this),this.ACTIVE_LIVE_IFRAME_TIMEOUT)},_runLiveUpdate:function(e){this.penHTMLKey=this._getStorePenHTMLKey(),this.penHTML=IFramePenToHTML.renderPenAsHTML(e),this._storePenHTMLOnBoomerang(this.penHTMLKey,this.penHTML)},_disabledCookiesUpdateIFrame:function(){$.showMessage(Copy.errors["disabled-cookies"],"slow");var e=URLBuilder.getViewURL("fullpage",CP.profiled,CP.pen,!0);this.resultDiv.html(this._getIFrameHTML("0",e))},_storePenHTMLOnBoomerang:function(e,t){var s={html:t,key:e};this.post("/boomerang",s,this._doneStorePenHTMLOnBoomerang)},_doneStorePenHTMLOnBoomerang:function(){this._replaceOldIFrameWithNew()},_getStorePenHTMLKey:function(){return this.penHTMLPrefix+(new Date).getTime()},IFRAME_LOAD_WAIT_TIME:300,updateIFrameTimeoutID:0,_replaceOldIFrameWithNew:function(){var e=this._getIFrameHTML(this.penHTMLKey,this._getIFrameURL(this.penHTMLKey));this.resultDiv.prepend(e),this._showNewIFrameOnload()},_showNewIFrameOnload:function(){$("#result"+this.penHTMLKey).load($.proxy(function(){clearTimeout(this.updateIFrameTimeoutID),this._removeOldIFrameShowNewIFrameClass()},this)),this.updateIFrameTimeoutID=setTimeout($.proxy(function(){this._removeOldIFrameShowNewIFrameClass()},this),this.IFRAME_LOAD_WAIT_TIME)},_removeOldIFrameShowNewIFrameClass:function(){for(var e=this.resultDiv.children("iframe"),t=0,s=e.length;s>t;t++)e[t].id!==this.activeIFrameID&&$(e[t]).remove();$("#"+this.activeIFrameID).removeClass("iframe-visual-update")},_getIFrameWidth:function(){return"top"===this.layoutStyle?$(window).width()+"px":"100%"},_getIFrameHTML:function(e,t){return"<iframe id='"+this._buildActiveIFrameID(e)+"' src='"+t+"' name='CodePen' allowfullscreen='true' sandbox='"+this.sandboxVal+"' allowTransparency='true' class='result-iframe iframe-visual-update' style='height: 100%; width: "+this._getIFrameWidth()+";'></iframe>"},_buildActiveIFrameID:function(e){return this.activeIFrameID="result"+e,this.activeIFrameID},_getIFrameURL:function(e){var t=document.location;return _.template(this._getIFrameURLTemplate(),{key:e,protocol:t.protocol,subdomain:"s.",host:this._getIFrameHost(),search:t.search,hash:t.hash})},_getIFrameHost:function(){return _isOnLocalhost()?"codepen.dev":"codepen.io"},_getIFrameURLTemplate:function(){return"<%= protocol %>//<%= subdomain %><%= host %>/boomerang/<%= key %>/index.html<%= search %><%= hash %>"}};IFrameRenderer.init();var PenRenderer=Class.extend({refHTML:"",refCSS:"",refJS:"",refHTMLPP:"",refCSSPP:"",refCSSPPLib:"",refJSPP:"",postProcessedHTML:"",postProcessedCSS:"",postProcessedJS:"",errors:{},INACTIVITY_TIMEOUT:900,MAX_TIME_BETWEEN_RENDER:3500,SHORT_INACTIVITY_TIMEOUT:400,INLINE_ERROR_TIMEOUT:1e3,_lastProcessAndRender:0,fullRefresh:!0,resources:[],init:function(){this.pageType=__pageType,this._attributesThatAffectPenUI=CP.pen.getAttributesThatAffectPenUI(),Instrument.init(),_.extend(this,AJAXUtil),this.procAndRender=_.throttle($.proxy(this.processAndRender,this),this.INACTIVITY_TIMEOUT),this._bindToHub(),this._loadInitialIframeResult()},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_onPenChange:function(e,t){for(var s in t.pen)_.contains(this._attributesThatAffectPenUI,s)&&this.compileContent()},_loadInitialIframeResult:function(){this.processAndRender()},compileContent:function(){CP.pen.auto_run&&(clearTimeout(this.previousCompileContentTimeoutID),this.previousCompileContentTimeoutID=setTimeout($.proxy(this.processAndRender,this),this._getCompileContentTimeout()))},_getCompileContentTimeout:function(){var e=_getTimeInMilliseconds()-this._lastProcessAndRender;return e>this.MAX_TIME_BETWEEN_RENDER?this.SHORT_INACTIVITY_TIMEOUT:this.INACTIVITY_TIMEOUT},setPostProcessed:function(e,t){this["postProcessed"+e.toUpperCase()]=t},getPostProcessed:function(e){return this["postProcessed"+e.toUpperCase()]},processAndRenderWithFullRefresh:function(){this.fullRefresh=!0,this.processAndRender()},processAndRender:function(){this._lastProcessAndRender=_getTimeInMilliseconds(),CP.penResources.processResourcesAndCallback(CP.pen,$.proxy(this.processContentAfterProcessingResources,this))},processContentAfterProcessingResources:function(e){this.resources=e;var t=this.getContentHashThatNeedsToBeProcessed();if(_.isEmpty(t)){var s={};this.handleProcessedPenData(s)}else t=CP.penResources.mergeResourcesAndPen(t,e),this.sendContentToServer(t)},getContentHashThatNeedsToBeProcessed:function(){var e={},t=this;return _.each(["html","css","js"],function(s){t.useCache(s)||(t._needsToBeProcessedOnServer(s)?"css"===s?(e.css=CP.pen.css,e.css_pre_processor=CP.pen.css_pre_processor,e.css_pre_processor_lib=CP.pen.css_pre_processor_lib,e.css_prefix=CP.pen.css_prefix):(e[s]=CP.pen[s],e[s+"_pre_processor"]=CP.pen[s+"_pre_processor"]):t.setPostProcessed(s,CP.pen[s]))}),e},_needsToBeProcessedOnServer:function(e){var t=CP.pen[e+"_pre_processor"];return"css"===e?t&&"none"!==t||"autoprefixer"===CP.pen.css_prefix:t&&"none"!==t},sendContentToServer:function(e){this.post("/preprocessors",e,this.doneSendcontentServer)},doneSendcontentServer:function(e){for(var t in e.results)this.setPostProcessed(t,e.results[t]);this.handleProcessedPenData(e.errors)},handleProcessedPenData:function(e){this.errors=ClientSidePenValidations.validate(CP.pen,e),this._instrumentJS(e),CP.penErrorHandler.handleErrorsInEditor(e),this.finishRendering()},_instrumentJS:function(e){this._shouldInstrumentAndCheckForErrors()&&(this.postProcessedJS=Instrument.js(CP.pen.js,e))},_shouldInstrumentAndCheckForErrors:function(){return CP.pen.js.match(/(React)/i)?!1:"none"===CP.pen.js_pre_processor&&CP.pen.js},finishRendering:function(){if(CP.penErrorHandler.canStillRenderPen(this.errors)){this.storeRefContent();var e=this.buildRenderablePen();Hub.pub("live_change",e),this.sendIFrameRenderablePen(e)}},buildRenderablePen:function(){return{html:this._getProcessedHTML(),html_classes:CP.pen.html_classes,head:CP.pen.head,css:this.postProcessedCSS,css_prefix:CP.pen.css_prefix,css_starter:CP.pen.css_starter,js:this.postProcessedJS,js_pre_processor:CP.pen.js_pre_processor,js_library:CP.pen.js_library,js_modernizr:CP.pen.js_modernizr,location_hash:window.location.hash,resources:this.resources,auto_run:CP.pen.auto_run,fullRefresh:this._getFullRefresh()}},_getProcessedHTML:function(){return CP.penResources.regexReplaceHTMLAfterProcessing(this.postProcessedHTML,this.resources)},_getFullRefresh:function(){var e=this.fullRefresh;return this.fullRefresh=!1,e},sendIFrameRenderablePen:function(e){IFrameRenderer.updateLiveIFrame(e)},storeRefContent:function(){this.refHTML=CP.pen.html,this.refHTMLPP=CP.pen.html_pre_processor,this.refCSS=CP.pen.css,this.refCSSPP=CP.pen.css_pre_processor,this.refCSSPPLib=CP.pen.css_pre_processor_lib,this.refCSSPrefix=CP.pen.css_prefix,this.refJS=CP.pen.js,this.refJSPP=CP.pen.js_pre_processor
},useCache:function(e){return _.size(this.errors)?!1:"html"===e?this.refHTML!==CP.pen.html||this.refHTMLPP!==CP.pen.html_pre_processor||this.hasResourceTypeWithAction("regex_replace")||this.hasResourceTypeWithAction("regex_replace_before_processing")?(this.setPostProcessed(e,""),!1):!0:"css"===e?this.refCSS!==CP.pen.css||this.refCSSPP!==CP.pen.css_pre_processor||this.refCSSPPLib!==CP.pen.css_pre_processor_lib||this.refCSSPrefix!==CP.pen.css_prefix||this.hasResourceTypeWithAction("prepend_to_css")?(this.setPostProcessed(e,""),!1):!0:this.refJS!==CP.pen.js||this.refJSPP!==CP.pen.js_pre_processor||this.hasResourceTypeWithAction("prepend_to_js")?(this.setPostProcessed(e,""),!1):!0},hasResourceTypeWithAction:function(e){for(var t=0;t<this.resources.length;t++)if(this.resources[t].action===e)return!0;return!1}}),PenResources=Class.extend({cachedResources:{},init:function(){_.extend(this,AJAXUtil)},processResourcesAndCallback:function(e,t){var s=e.html,i=ExternalsUtil.getExternalsAsArray(e.css_external),n=ExternalsUtil.getExternalsAsArray(e.js_external),o=this._findResourcesNeedingToBeProcess(s,i,n);this._needsToBeSentForProcessing(o)?this._processResourcesAndRunCallback(e,t):t(this._useCachedResources(o)?_.values(this.cachedResources):this._convertSimpleCSSJSURLsToResourceObjects(i,n))},_findResourcesNeedingToBeProcess:function(e,t,s){var i={};return i=_.extend(i,this._getHTMLResourcesToProcess(e)),i=_.extend(i,this._getCSSAndJSResourcesToProcess("css",t)),i=_.extend(i,this._getCSSAndJSResourcesToProcess("js",s))},_getHTMLResourcesToProcess:function(e){for(var t={},s=/\[\[\[\S+\]\]\]/gm,i=i=s.exec(e);i;)t[this._getResourceKey("html",i[0])]=i[0],i=i=s.exec(e);return t},_getCSSAndJSResourcesToProcess:function(e,t){var s={};return _.each(t,$.proxy(function(t){this._isURLResourceNeedingProcessing(t)&&(s[this._getResourceKey(e,t)]=t)},this)),s},_isURLResourceNeedingProcessing:function(e){return this._urlRefersToPenURL(e)||this._urlRefersToCSSNeedingToBePreprocessed(e)||this._urlRefersToJSNeedingToBePreprocessed(e)},_urlRefersToPenURL:function(e){return/\/\S+\/pen\/\w{5,}$/i.test(e)},_urlRefersToCSSNeedingToBePreprocessed:function(e){return/\.(scss|sass|less|stylus)$/i.test(e)},_urlRefersToJSNeedingToBePreprocessed:function(e){return/\.(coffeescript|livescript|traceur)$/i.test(e)},_getResourceKey:function(e,t){return e+"_"+t},_needsToBeSentForProcessing:function(e){return navigator.cookieEnabled?_.isEmpty(e)?!1:!this._hasAllResourcesNeedingToBeProcessedCached(e):!1},_processResourcesAndRunCallback:function(e,t){var s="/process_external_resources",i=this._getProcessResourcesParams(e);this.post(s,i,$.proxy(function(e){this._doneProcessExternalResources(e,t)},this))},_getProcessResourcesParams:function(e){return{html_pre_processor:e.html_pre_processor,html:e.html,css_pre_processor:e.css_pre_processor,css_pre_processor_lib:e.css_pre_processor_lib,css_prefix:e.css_prefix,css_external:e.css_external,js_pre_processor:e.js_pre_processor,js_external:e.js_external}},_doneProcessExternalResources:function(e,t){var s=JSON.parse(e.resources);this._cacheResources(s),t(s)},_cacheResources:function(e){this.cachedResources={};for(var t=0,s=e.length;s>t;t++)this.cachedResources[this._getCacheResourceKey(e[t])]=e[t]},_getCacheResourceKey:function(e){var t=TypesUtil.syntaxToType(e.type),s=e.url?e.url:e.text_to_replace;return t+"_"+s},_useCachedResources:function(e){return 0===_.size(e)?!1:this._hasAllResourcesNeedingToBeProcessedCached(e)},_hasAllResourcesNeedingToBeProcessedCached:function(e){var t=_.keys(this.cachedResources),s=_.keys(e),i=_.difference(s,t);return 0===i.length},_convertSimpleCSSJSURLsToResourceObjects:function(e,t){var s=[];return _.each(e,function(e){e&&s.push({action:"include_css_url",url:e})}),_.each(t,function(e){e&&s.push({action:"include_js_url",url:e})}),s},mergeResourcesAndPen:function(e,t){e.html&&(e.html=this._regexReplaceHTMLBeforeProcessing(e.html,t));var s=this._getPrependFromResources("css",t);s&&(e.css=s+e.css);var i=this._getPrependFromResources("js",t);return i&&(e.js=i+e.js),e},_getPrependFromResources:function(e,t){for(var s="",i=0,n=t.length;n>i;i++)t[i].action==="prepend_to_"+e&&(s+=t[i].content+"\n","js"===e&&(s+=";"));return s},regexReplaceHTMLAfterProcessing:function(e,t){return this._regexReplaceHTML(e,"regex_replace",t)},_regexReplaceHTMLBeforeProcessing:function(e,t){return this._regexReplaceHTML(e,"regex_replace_before_processing",t)},_regexReplaceHTML:function(e,t,s){for(var i=0;i<s.length;i++)if(s[i].action===t){var n=s[i].text_to_replace;n=n.replace(/\//g,"\\/"),n=n.replace(/\[/g,"\\["),n=n.replace(/\]/g,"\\]");var o=new RegExp(n,"g");e=e.replace(o,s[i].content)}return e}}),RTClient=Class.extend({connect:function(e,t,s){this._connect(e,t,s),this._handleUnload(e)},_HEART_BEAT:60,_connect:function(e,t,s){this.pubnub=PUBNUB.init({publish_key:"pub-c-2dc172d2-d77c-4ab0-aa37-13d5b7c7c63e",subscribe_key:"sub-c-e10c7f7e-3cfb-11e4-949a-02ee2ddab7fe",uuid:e.rtClientID});var i=this;this.pubnub.subscribe({channel:e.roomID,message:$.proxy(this._onMessage,this),connect:function(){i._setState(e),t()},error:s,presence:function(){i._onPresence(e)},heartbeat:this._HEART_BEAT})},_setState:function(e){this.pubnub.state({channel:e.roomID,state:e.user})},_handleUnload:function(e){var t=this;$(window).unload(function(){t.unsubscribe(e)})},showStandardUnableToConnectWarning:function(){$.showModal("/ajax/realtime/unable_to_connect","modal-warning modal-single-message")},publish:function(e,t,s){var i=this;_.forEach(this._getMessagesToPublish(e,t,s),function(e){i.pubnub.publish({channel:t.roomID,message:e})})},MAX_MESSAGE_LENGTH:12e3,_getMessagesToPublish:function(e,t,s){var i=this._buildEvent(e,t,s),n=JSON.stringify(i),o=n.length;if(o<this.MAX_MESSAGE_LENGTH)return i.part=!1,[i];for(var r=[],a=_getTimeInMilliseconds(),l=0;o>l;)r.push({id:a,index:r.length,part:n.substring(l,l+this.MAX_MESSAGE_LENGTH)}),l+=this.MAX_MESSAGE_LENGTH;return _.forEach(r,function(e){e.length=r.length}),r},calculatePayloadSize:function(e,t){return encodeURIComponent(e+JSON.stringify(t)).length+100},_buildEvent:function(e,t,s){return{type:e,data:s,rtData:t}},_onEvents:{},_messages:{},_onMessage:function(e){e.part?this._handleReconstituingMessage(e):this._handleFullMessage(e)},_handleReconstituingMessage:function(e){var t=this._getMsgArray(e);if(t[e.index]=e.part,t.length===e.length){delete this._messages[e.id];var s=t.join("");try{var i=JSON.parse(s);this._handleFullMessage(i)}catch(n){console.log(n)}}},_getMsgArray:function(e){return"undefined"==typeof this._messages[e.id]&&(this._messages[e.id]=[]),this._messages[e.id]},_handleFullMessage:function(e){this._onEvents[e.type]&&this._onEvents[e.type](e)},subscribe:function(e,t,s,i){var n=this;"boolean"!=typeof i&&(i=!1),this._onEvents[e]=function(e){(i||n._shouldHandleEvent(t,e))&&s(e)}},_shouldHandleEvent:function(e,t){return e.rtClientID!==t.rtData.rtClientID},unsubscribe:function(e){this.pubnub.unsubscribe({channel:e.roomID})},republishRoomCounts:function(e){this._onPresence(e)},_onPresence:function(e){this.pubnub.here_now({channel:e.roomID,state:!0,callback:function(e){var t=_.map(e.uuids,function(e){return e.state});Hub.pub("room-count-change",{users:t})}})}}),BaseSettingsController=Class.extend({setPenValue:function(e){this.pen.setPenValue(e)},toggleSettingsPane:function(){this.model.toggleSettingsPane()},hideSettingsPane:function(e){this.model.hideSettingsPane(e)},syncWithServer:function(e){this.model.syncWithServer(e)},addExternalResource:function(){this.model.addExternalResource()}}),BaseSettingsEvents=Class.extend({type:"",_enabled:!0,$allEls:$(".settings input, .settings textarea, .settings select, .settings button"),init:function(e){this.controller=e,this._baseBindToDOM(),this._baseBindToHub()},_baseBindToDOM:function(){$(this._getToggleSettingsPaneSelector())._on("click",this._toggleSettingsPane,this),_hideElementWhenUserClicksAway(this._getHideElementsSelector(),$.proxy(this._hideSettingsPane,this)),$(".add-resource[data-type='"+this.type+"']").on("click",$.proxy(this._onAddResourceClick,this)),$("body").on("keyup change","."+this.type+"-resource",$.proxy(this._onExternalResource,this)).on(".prevent-form-submit","submit",function(e){return e.preventDefault(),!1})},_getToggleSettingsPaneSelector:function(){return"#box-"+this.type+" .settings-nub, #settings-pane-"+this.type},_getHideElementsSelector:function(){return".settings, .settings-nub"},_onAddResourceClick:function(){this._enabled&&this.controller.addExternalResource()},_onExternalResource:function(){if(this._enabled){var e={origin:"client",pen:{}};e.pen[this.type+"_external"]=this._getExternalsValue(),this.controller.setPenValue(e)}},_getExternalsValue:function(){var e=_.map($("."+this.type+"-resource"),function(e){return e.value});return e.join(";")},_baseBindToHub:function(){Hub.sub("ui-disable",$.proxy(this._disableUI,this)),Hub.sub("ui-enable",$.proxy(this._enableUI,this)),Hub.sub("key",$.proxy(this._onKey,this)),Hub.sub("server-ui-change",$.proxy(this._onServerUIChange,this)),Hub.sub("server-pen-change",$.proxy(this._onServerPenChange,this))},_onKey:function(e,t){"esc"===t.key&&this._hideSettingsPane()},_onServerUIChange:function(e,t){("settingsPanes"in t.ui||"externalInputs"in t.ui)&&this.controller.syncWithServer(t)},_onServerPenChange:function(e,t){this.controller.setPenValue(t)},_disableUI:function(){this._enabled=!1,this.$allEls.attr("disabled",!0)},_enableUI:function(){this._enabled=!0,this.$allEls.attr("disabled",!1)},_toggleSettingsPane:function(){this._enabled&&this.controller.toggleSettingsPane()},_hideSettingsPane:function(e){if(this._enabled&&this._notPartOfTypeahead(e)){var t={type:this.type};this.controller.hideSettingsPane(t)}},_notPartOfTypeahead:function(e){return e?0===$(e.target).closest(".tt-suggestion").length:!0},_buildBasicData:function(e){return{origin:"client",pen:e}}}),BaseSettingsModel=Class.extend({type:"",OPEN:"open",CLOSED:"closed",init:function(){this._setSettingsPane(this.CLOSED),this._setExternalInputsCount()},_setExternalInputsCount:function(){var e=CP.pen[this.type+"_external"];e&&(CP.ui.externalInputs[this.type]=ExternalsUtil.getExternalsLength(e))},toggleSettingsPane:function(){this._updateAttributeState(),this._pubUISettingsChange()},_updateAttributeState:function(){var e=this._getSettingsPaneState(),t=this._getToggledPaneState(e);this._setSettingsPane(t)},_getToggledPaneState:function(e){return e===this.OPEN?this.CLOSED:this.OPEN},hideSettingsPane:function(){this._setSettingsPane(this.CLOSED),this._pubUISettingsChange()},setSettingsPaneState:function(e){this._setSettingsPane(e.value),this._pubUISettingsChange()},_getSettingsPaneState:function(){return CP.ui.settingsPanes[this.type]},_setSettingsPane:function(e){CP.ui.settingsPanes={ui:{settingsPanes:{css:"closed",html:"closed",js:"closed"}}},CP.ui.settingsPanes[this.type]=e},syncWithServer:function(e){var t;for(t in e.ui.settingsPanes)CP.ui.settingsPanes[t]=e.ui.settingsPanes[t],this._pubUISettingsChange();for(t in e.ui.externalInputs)e.ui.externalInputs[t]&&(CP.ui.externalInputs[t]=e.ui.externalInputs[t],this._pubExternalResourceChange())},_pubUISettingsChange:function(){var e={ui:{settingsPanes:_.clone(CP.ui.settingsPanes)}};Hub.pub("ui-change",e)},addExternalResource:function(){CP.ui.externalInputs[this.type]+=1,this._pubExternalResourceChange()},_pubExternalResourceChange:function(){var e={ui:{externalInputs:{}}};e.ui.externalInputs[this.type]=CP.ui.externalInputs[this.type],Hub.pub("ui-change",e)}}),BaseSettingsView=Class.extend({OPEN:"open",CLOSED:"closed",type:"",_enabled:!0,init:function(){this._baseBindToHub(),this._syncExternalInputs()},_syncExternalInputs:function(){for(var e in CP.ui.externalInputs){var t=CP.ui.externalInputs[e];this._syncExternalInputsToModel(t),this._setExternalInputsCount(e)}},_setExternalInputsCount:function(e){var t=CP.pen[e+"_external"];if(t){var s=ExternalsUtil.getExternalsAsArray(t);$("."+e+"-resource").each(function(e,t){t=$(t),t.val()!==s[e]&&t.val(s[e])})}},_baseBindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChangeBase,this)),Hub.sub("ui-change",$.proxy(this._onUIChangeBase,this)),Hub.sub("ui-disable",$.proxy(this._disableUI,this)),Hub.sub("ui-enable",$.proxy(this._enableUI,this))},_disableUI:function(){this._enabled=!1,this._disableInputs()},_disableInputs:function(){$("."+this.type+"-resource").attr("disabled",!0)},_enableUI:function(){this._enabled=!0,this._enableInputs()},_enableInputs:function(){$("."+this.type+"-resource").attr("disabled",!1)},_onPenChangeBase:function(){this._setExternalInputsCount(this.type)},_onUIChangeBase:function(e,t){var s;if(this._isSettingPaneTypeChange(t)&&this._updateSettingsPaneState(t.ui.settingsPanes),"externalInputs"in t.ui)for(s in t.ui.externalInputs)if(s===this.type){var i=t.ui.externalInputs[s];this._syncExternalInputsToModel(i)}},_isSettingPaneTypeChange:function(e){return e.ui&&e.ui.settingsPanes?!0:!1},_updateSettingsPaneState:function(e){var t,s=!1;for(t in e){var i=e[t],n=$("#settings-"+t),o=$("#settings-pane-"+t);"open"===i?(s=!0,n.addClass(this.OPEN),o.addClass(this.OPEN),n[0].getBoundingClientRect().bottom>window.innerHeight?(n.addClass("flip-it"),n[0].getBoundingClientRect().top<0&&(n.removeClass("flip-it").addClass("screw-it"),$("body").addClass("settings-super-center"))):n.removeClass("flip-it")):(n.removeClass(this.OPEN),o.removeClass(this.OPEN),n.removeClass("flip-it screw-it"))}s||$("body").removeClass("settings-super-center")},_syncExternalInputsToModel:function(e){for(var t=e-$("."+this.type+"-resource").length;t>0;)this._addExternalResourceInputEl(),t+=-1},_addExternalResourceInputEl:function(){var e=$("<div />",{"class":"external-resource-wrapper",html:this._getExternalResourceInputHTML(this.type)});this._appendExternalResourceInputEl(this.type,e)},_getExternalResourceInputHTML:function(e){var t="css"===e?"style.css":"script.js",s=this._enabled?"":"disabled='disabled'";return"<input class='"+e+"-resource fullwidth external-resource' type='url' "+s+" placeholder='https://yourwebsite.com/"+t+"'><small class='error'>Must be a valid URL.</small>"},_appendExternalResourceInputEl:function(e,t){$("#external-"+e+"-resources > .external-resource-wrapper").last().after(t)},VALIDATE_URL_TIMEOUT:2e3,validateURLTimeoutID:0,hasURLError:!1,_validateExternalURLOnChangeGracefully:function(){var e=$(":focus");e.hasClass(this.type+"-resource")&&(clearTimeout(this.validateURLTimeoutID),this.validateURLTimeoutID=setTimeout($.proxy(function(){this._validateExternalURLOnChange(e.first())},this),this.VALIDATE_URL_TIMEOUT))},_validateExternalURLOnChange:function(e){_isValidURL(e.val())?e.next(".error").hide():e.next(".error").show().css("display","block")}}),CSSSettingsController=BaseSettingsController.extend({type:"css",init:function(e){this.pen=e,this.events=new CSSSettingsEvents(this),this.model=new CSSSettingsModel,this.view=new CSSSettingsView(e)}}),CSSSettingsEvents=BaseSettingsEvents.extend({type:"css",init:function(e){this._super(e),this._bindToDOM()},_bindToDOM:function(){$("input[name='css-preprocessor']")._on("click",this._selectPreProcessor,this,!0),$(".css-pre-processor-libs")._on("change",this._selectPreProcessorLib,this,!0),$("input[name='startercss']")._on("click",this._selectStartCSS,this,!0),$("input[name='prefix']")._on("click",this._selectCSSPrefix,this,!0)},_selectPreProcessor:function(e,t){var s=this._getSelectPreProcessorData(t);this.controller.setPenValue(s)},_getSelectPreProcessorData:function(e){var t=e.val(),s=$("#"+t+"-options"),i=s.length>0?s.val():"";return this._buildBasicData({css_pre_processor:t,css_pre_processor_lib:i})},_selectPreProcessorLib:function(e,t){var s=this._getSelectPreProcessorLibData(t);this.controller.setPenValue(s)},_getSelectPreProcessorLibData:function(e){return this._buildBasicData({css_pre_processor:e.data("css-pre-processor"),css_pre_processor_lib:e.val()})},_selectStartCSS:function(e,t){var s=this._buildBasicData({css_starter:t.val()});this.controller.setPenValue(s)},_selectCSSPrefix:function(e,t){var s=this._buildBasicData({css_prefix:t.val()});this.controller.setPenValue(s)}}),CSSSettingsModel=BaseSettingsModel.extend({type:"css",init:function(){this._super()}}),CSSSettingsView=BaseSettingsView.extend({boxCSSEl:$("#box-css"),type:"css",init:function(e){this._super(),this._bindToHub(),this._updateUI(e)},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_onPenChange:function(e,t){this._updateUI(t.pen)},_updateUI:function(e){"css_pre_processor"in e&&this._setPreProcessor(e),"css_pre_processor_lib"in e&&this._selectCSSPreProcessorLib(e),"css_starter"in e&&this._selectCSSStarter(e),"css_prefix"in e&&this._selectCSSPrefix(e)},_setPreProcessor:function(e){$("#box-css").hasClass("view-compiled")&&$("#CSS-view-compiled").click(),this._selectPreProcessor(e),this._addClassesToBoxCSS(e)},_selectPreProcessor:function(e){var t=":input[name='css-preprocessor'][value='"+e.css_pre_processor+"']";$(t).prop("checked",!0)},_addClassesToBoxCSS:function(e){this.boxCSSEl.removeClass("none scss sass less stylus").addClass(e.css_pre_processor)},_selectCSSPreProcessorLib:function(e){_.contains(["sass","scss","less","stylus"],e.css_pre_processor)&&$("#"+e.css_pre_processor+"-options").val(e.css_pre_processor_lib)},_selectCSSStarter:function(e){$("#startercss-options-form input[value='"+e.css_starter+"']").prop("checked",!0)},_selectCSSPrefix:function(e){$("#prefix-options-form input[value='"+e.css_prefix+"']").prop("checked",!0),this._addCSSPrefixClassToBoxCSS(e)},_addCSSPrefixClassToBoxCSS:function(e){this.boxCSSEl.removeClass("autoprefixer").addClass(e.css_prefix)}}),ExternalsTypeahead=Class.extend({init:function(){__mobile||(this._bindToDOM(),this._bindToHub())},_bindToDOM:function(){$("#external-js, #external-css").one("click",$.proxy(this._onClickIntoExternalResourceInput,this))},_onClickIntoExternalResourceInput:function(e){this._bindToInputBoxes(),$(e.target).focus()},_bindToHub:function(){Hub.sub("ui-change",$.proxy(this._onUIChange,this))},_onUIChange:function(e,t){"externalInputs"in t.ui&&this._bindToInputBoxes()},_bindToInputBoxes:function(){$(".external-resource").off("typeahead:selected").on("typeahead:selected",function(){$(this).trigger("change")}),this._bindJSExternalsToTypeAhead(),this._bindCSSExternalsToTypeAhead()},_bindJSExternalsToTypeAhead:function(){var e=this;$(".js-resource").each(function(t,s){s=$(s),s.data("typeahead-bound")||(s.typeahead({name:"js_libs",prefetch:"/assets/editor/other/cdn/cdnjs_data.json",limit:1e3,template:e.typeaheadTemplate,engine:e.templateEngine}),s.data("typeahead-bound",!0))})},_bindCSSExternalsToTypeAhead:function(){var e=this;$(".css-resource").each(function(t,s){s=$(s),s.data("typeahead-bound")||(s.typeahead({name:"css_libs",prefetch:"/assets/editor/other/cdn/cdncss_data.json",limit:1e3,template:e.typeaheadTemplate,engine:e.templateEngine}),s.data("typeahead-bound",!0))})},templateEngine:{compile:function(e){var t=_.template(e);return{render:function(e){return t(e)}}}},typeaheadTemplate:_.template("<p><%= name %><small><%= value %></small></p>")}),ExternalsUtil={getExternalsLength:function(e){return this.getExternalsAsArray(e).length},getExternalsAsArray:function(e){var t=e||"";return _.compact(t.split(";"))}},HTMLSettingsController=BaseSettingsController.extend({type:"html",init:function(e){this.pen=e,this.events=new HTMLSettingsEvents(this),this.model=new HTMLSettingsModel(this),this.view=new HTMLSettingsView(e)}}),HTMLSettingsEvents=BaseSettingsEvents.extend({type:"html",init:function(e){this._super(e),this._bindToDOM()},_bindToDOM:function(){$("input[name='html-preprocessor']")._on("click",this._selectPreProcessor,this,!0),$("#head-content")._on("keyup change",this._setHead,this,!0),$("#html-classes")._on("keyup change",this._setHTMLClasses,this,!0),$("#meta-tag-insert")._on("click",this.addCommonMetaTag,this,!0)},_selectPreProcessor:function(e,t){var s=this._buildBasicData({html_pre_processor:t.val()});this.controller.setPenValue(s)},_setHead:function(e,t){var s=this._buildBasicData({head:t.val()});this.controller.setPenValue(s)},_setHTMLClasses:function(e,t){var s=this._buildBasicData({html_classes:t.val()});this.controller.setPenValue(s)},addCommonMetaTag:function(){var e="",t=$("#head-content").val();e=t?t+'\n<meta name="viewport" content="width=device-width">':'<meta name="viewport" content="width=device-width">';var s=this._buildBasicData({head:e});this.controller.setPenValue(s)}}),HTMLSettingsModel=BaseSettingsModel.extend({type:"html",init:function(){this._super()}}),HTMLSettingsView=BaseSettingsView.extend({boxHTMLEl:$("#box-html"),htmlClassesEl:$("#html-classes"),headEl:$("#head-content"),type:"html",init:function(e){this._super(),this._bindToHub(),this._updateUI(e)},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_onPenChange:function(e,t){this._updateUI(t.pen)},_updateUI:function(e){"html_pre_processor"in e&&this._setPreProcessor(e.html_pre_processor),"head"in e&&this._setHead(e.head),"html_classes"in e&&this._setHTMLClasses(e.html_classes)},_setHead:function(e){this.headEl.val(e)},_setHTMLClasses:function(e){this.htmlClassesEl.val(e)},_setPreProcessor:function(e){$("#box-html").hasClass("view-compiled")&&$("#HTML-view-compiled").click(),this._addClassBoxHTML(e),this._selectPreProcessor(e)},_selectPreProcessor:function(e){var t=":input[name='html-preprocessor'][value='"+e+"']";$(t).prop("checked",!0)},_addClassBoxHTML:function(e){this.boxHTMLEl.removeClass("none slim jade haml markdown").addClass(e)}}),JSSettingsController=BaseSettingsController.extend({type:"js",init:function(e){this.pen=e,this.events=new JSSettingsEvents(this),this.model=new JSSettingsModel(this),this.view=new JSSettingsView(e)}}),JSSettingsEvents=BaseSettingsEvents.extend({type:"js",init:function(e){this._super(e),this._bindToDOM()},_bindToDOM:function(){$("input[name='js-preprocessor']")._on("click",this._selectPreProcessor,this,!0),$("#js-select")._on("change",this._setJSLibrary,this,!0),$("#modernizr")._on("click",this._setJSModernizr,this,!0),$("#auto-run")._on("click",this._setAutoRun,this,!0)},_selectPreProcessor:function(e,t){var s=this._buildBasicData({js_pre_processor:t.val()});this.controller.setPenValue(s)},_setJSLibrary:function(e,t){var s=this._buildBasicData({js_library:t.val()});this.controller.setPenValue(s)},_setJSModernizr:function(e,t){var s=this._buildBasicData({js_modernizr:t.is(":checked")});this.controller.setPenValue(s)},_setAutoRun:function(e,t){var s=this._buildBasicData({auto_run:t.is(":checked")});this.controller.setPenValue(s)}}),JSSettingsModel=BaseSettingsModel.extend({type:"js",init:function(){this._super()}}),JSSettingsView=BaseSettingsView.extend({$boxJSEl:$("#box-js"),$autoRun:$("#auto-run"),$modernizr:$("#modernizr"),$body:$("body"),$jsSelect:$("#js-select"),type:"js",init:function(e){this._super(),this._bindToHub(),this._updateUI(e)},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_onPenChange:function(e,t){this._updateUI(t.pen)},_updateUI:function(e){"js_pre_processor"in e&&this._setPreProcessor(e.js_pre_processor),"js_modernizr"in e&&this._selectJSModernizr(e.js_modernizr),"js_library"in e&&this._selectJSLibrary(e.js_library),"auto_run"in e&&this._setAutoRun(e.auto_run)},_setPreProcessor:function(e){$("#box-js").hasClass("view-compiled")&&$("#JS-view-compiled").click(),this._addClassBoxJS(e),this._selectPreProcessor(e)},_selectPreProcessor:function(e){var t=":input[name='js-preprocessor'][value='"+e+"']";$(t).prop("checked",!0)},_addClassBoxJS:function(e){this.$boxJSEl.removeClass("none coffeescript livescript traceur").addClass(e)},_selectJSLibrary:function(e){this.$jsSelect.val(e)},_selectJSModernizr:function(e){e&&this.$modernizr.prop("checked",!0)},_setAutoRun:function(e){e?(this.$autoRun.prop("checked",!0),this.$body.removeClass("show-run-button")):(this.$autoRun.prop("checked",!1),this.$body.addClass("show-run-button"))}}),ShareGist=Class.extend({WAITING_MSG_TIMEOUT:1e4,GIST_MSG_TIMEOUT:7e3,init:function(e){_.extend(this,AJAXUtil),this._shareView=e,this._bindToDOM()},_bindToDOM:function(){$("#share-gist")._on("click",$.proxy(this._createGist,this))},_createGist:function(){this._shareView.hideShareView(),$.showMessage(Copy.waitingForGist,this.WAITING_MSG_TIMEOUT);var e=CP.profiled.base_url+"/share/gist.json";this.post(e,{data:JSON.stringify(CP.pen)},this._doneCreateGist)},_doneCreateGist:function(e){var t=_.template(Copy.gistCreated,{url:e.url});$.showMessage(t,this.GIST_MSG_TIMEOUT),window.open(e.url)}}),ShareSMS=Class.extend({$sendToPhone:$("#send-to-phone"),$sendToPhoneForm:$("#send-to-phone-form"),$sendButton:$("#sms-send-button"),$smsPhone:$("#sms-phone"),$errorMessage:$(".error-message"),$textsLeft:$("#texts-left"),init:function(e){_.extend(this,AJAXUtil),this._shareView=e,this._bindToDOM(),this._loadSMSPhoneNumberFromCookie()},_bindToDOM:function(){this.$sendToPhoneForm._on("submit",this.sendSMS,this)},_loadSMSPhoneNumberFromCookie:function(){$.cookie("sms_phone_number")&&this.$sendToPhone.val($.cookie("sms_phone_number"))},sendSMS:function(){this.$sendButton.prop("disabled",!0);var e=CP.profiled.base_url+"/share/sms/"+CP.pen.slug_hash,t={phone_number:this.$sendToPhone.val()};this.post(e,t,this._doneSendSMS,this._failedSendSMS)},_doneSendSMS:function(e){this._shareView.hideShareView(),this._clearSMSErrors(),this._setSMSPhoneNumberCookie(e),this.$sendButton.prop("disabled",!1),this.$textsLeft.html(e.sms_left),$.showMessage(_.template(Copy.smsSentTo,{phone_number:e.phone_number}),"slow")},_setSMSPhoneNumberCookie:function(e){var t={expires:30,domain:this.getAllDomain(),path:"/"};$.cookie("sms_phone_number",e.phone_number,t)},getAllDomain:function(){return"."+document.location.host},_failedSendSMS:function(e){this._clearSMSErrors(),this.$sendButton.prop("disabled",!1),this.$smsPhone.addClass("error"),this.$smsPhone.append(this._getErrorsHTML(e))},_getErrorsHTML:function(e){var t="";for(var s in e.errors)t+="<div class='error-message'>"+e.errors[s]+"</div>";return t},_clearSMSErrors:function(){this.$smsPhone.removeClass("error"),this.$errorMessage.remove()}}),ShareView=Class.extend({$sharingButton:$("#sharing-button"),$sharingPanel:$("#sharing-panel"),$shareButtons:$("#share-buttons"),init:function(){_.extend(this,AJAXUtil),this.pageType=__pageType,this.shareSMS=new ShareSMS(this),this.shareGist=new ShareGist(this),this._bindToDOM(),this._bindToHub(),this._updateRoomLinks()},_bindToHub:function(){Hub.sub("key",$.proxy(this._onKey,this)),Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_bindToDOM:function(){this.$sharingButton._on("click",this._toggleSharePane,this),_hideElementWhenUserClicksAway("#sharing-panel",$.proxy(this.hideShareView,this)),$("#sharing-panel > *").on("click",function(e){e.stopPropagation()})},_onKey:function(e,t){"esc"===t.key&&this.hideShareView()},_toggleSharePane:function(){this.$sharingPanel.slideToggle(100,function(){$(this).css("overflow","visible")}),this._hideOtherElements()},_hideOtherElements:function(){$.hideMessage(),CP.infoController&&CP.infoController.hideOnly()},hideShareView:function(){this.$sharingButton.removeClass("active"),this.$sharingPanel.hide()},_onPenChange:function(e,t){t.pen.private&&this._updateRoomLinks()},_updateRoomLinks:function(){$("#editor-link").attr("href",this._getViewURL("pen")),$("#details-link").attr("href",this._getViewURL("details")),$("#full-page-link").attr("href",this._getViewURL("full")),$("#full-page-url").val(URLBuilder.getShortViewURL("",CP.pen)),$("#live-view-link").attr("href",this._getViewURL("live")),$("#live-view-url").val(URLBuilder.getShortViewURL("v",CP.pen));var e=this._getViewURL("collab");$("#collab-view-link").attr("href",e),$("#collab-link").attr("href",e),$("#collab-view-url").val(URLBuilder.getShortViewURL("c",CP.pen));var t=this._getViewURL("professor");$("#professor-view-link").attr("href",t),$("#professor-link").attr("href",t),$("#professor-view-url").val(URLBuilder.getShortViewURL("p",CP.pen)),$("#share-zip").attr("href",this._getViewURL("share/zip"))},_getViewURL:function(e){return URLBuilder.getViewURL(e,CP.profiled,CP.pen,!1)}}),Copy={autoSavingNow:"Autosave enabled. <a href='http://blog.codepen.io/documentation/editor/autosave/' target='_blank'>(?)</a>",penUpdated:"Pen saved.",penForked:"We forked this Pen. It's saved to your account, but you can <a href='<%= url %>' target='_blank'>view it here.</a>",waitingForGist:"Creating GitHub Gist. Please be patient and stay awesome.",gistCreated:"Thanks for staying awesome. <a href='<%= url %>' target='_blank'> Here's a link to your Gist.</a>",youHaveUnsavedChanges:"You have NOT saved your Pen. Stop and save if you want to keep your Pen.",collectionSavedPenAdded:"Your Collection '<%= name %>' was created and this Pen was added to it. <a href='<%= url %>'>View Collection</a>.",penAddToCollection:"This Pen was added to the '<%= name %>' collection. <a href='<%= url %>'>View collection</a>.",smsSentTo:"Text sent to phone <%= phone_number %>.",pauseAndPlay:"Pause and Play",catchUpToClass:"Catch Up to Class",studentWatching:"Student Watching",studentsWatching:"Students Watching",unsubcribedFromCommentNotifications:"You've been unsubscribed from comments for this Pen",subscribedToCommentNotifications:"You've been subscribed to comments for this Pen",deletingPen:"Deleting this Pen. Buckle up!",cleanErrorsFirst:"There are errors that must be cleared first.",viewSource:"View Source",returnToSource:"Return to Source",errors:{"waiting-to-save-pen":"Still waiting to save Pen. Try saving again.","anon-cannot-save-empty-pen":"You cannot save an empty Pen. Make something beautiful.","anon-cannot-save-during-rt-session":"Please login to save this Pen.","unable-to-save-try-again":"Unable to save Pen. Trying again for the <%= time %> time. Please be patient.","unable-to-save-ever":"Unable to save pen. Please contact support@codepen.io.","disabled-cookies":"You will not be able to see live changes to a Pen while cookies are disabled","pen-too-large":"This Pen is larger than the 1 megabyte limit. Try removing data from this Pen and trying again."}},CPFactory={buildDataObjects:function(){CP.pen=new Pen,CP.profiled=new Profiled,CP.user=new User,CP.ui=UI.buildDefaultUIData()},buildEditorObjects:function(){CP.penErrorHandler=new PenErrorHandler,CP.penResources=new PenResources,CP.penRenderer=new PenRenderer,CP.codeEditorAnalayze=new CodeEditorAnalyze,CP.htmlEditor=new HTMLEditor("html",CP.pen.html),CP.cssEditor=new CSSEditor("css",CP.pen.css),CP.jsEditor=new JSEditor("js",CP.pen.js),CP.infoController=new InfoController,CP.shareView=new ShareView,CP.htmlSettingsController=new HTMLSettingsController(CP.pen),CP.cssSettingsController=new CSSSettingsController(CP.pen),CP.jsSettingsController=new JSSettingsController(CP.pen)},buildDesktopViewEditorObjects:function(){CP.codeEditorResizeController=new CodeEditorsResizeController,CP.codeEditorsCSSTransitionHandler=new CodeEditorsCSSTransitionHandler,CP.codeEditorsLinkClicker=new CodeEditorsLinkClicker,CP.codeEditorsViewSourceController=new CodeEditorsViewSourceController,CP.externalsTypeahead=new ExternalsTypeahead,CP.keyBindings=new KeyBindings}},HandleIFrameClicks={init:function(e){this.pen=e,this._bindToDOM()},_bindToDOM:function(){window.addEventListener?window.addEventListener("message",$.proxy(this.handleIFrameClickEvent,this),!1):window.attachEvent("onmessage",$.proxy(this.handleIFrameClickEvent,this))},handleIFrameClickEvent:function(e){if(this._allowedToOpenWindows()){var t=this._cleanURL(this._getURLFromEvent(e));t.match(/^https?:\/\/\S+$/)&&window.open(t)}},_allowedToOpenWindows:function(){return this.pen.user_id>1},_getURLFromEvent:function(e){return"string"==typeof e.data?e.data:""},_cleanURL:function(e){var t=this._getIFrameURLRemoved(e);return t=this._sanitizeURL(t),t=t.replace(/(java|vb)?script/gim,""),t=t.replace(/eval/gim,""),t=t.split("?")[0]},_getIFrameURLRemoved:function(e){return e.replace(/http(s)?:\/\/(s\.)?codepen\.(dev|io)\/(boomerang\/\S+|\S+\/fullpage)\/\w+(\.html)?/m,"")},_sanitizeURL:function(e){return e.replace(/[^-A-Za-z0-9+&@#/%?=~_|!:,.;\(\)]/,"")}},Loader={loaded:[],files:{"analyze-js":"/assets/libs/jshint.js;/assets/editor/other/analyze.js","analyze-html":"/assets/libs/html-inspector.js;/assets/editor/other/analyze.js","analyze-css":"/assets/libs/csslint.js;/assets/editor/other/analyze.js",htmlparser:"/assets/libs/htmlparser.js",mode_text:"",mode_xml:"",mode_markdown:"/assets/libs/codemirror/mode/markdown/markdown.js",mode_haml:"/assets/libs/codemirror/mode/htmlmixed/htmlmixed.js;/assets/libs/codemirror/mode/ruby/ruby.js;/assets/libs/codemirror/mode/haml/haml.js",mode_python:"/assets/libs/codemirror/mode/python/python.js","mode_application/x-slim":"/assets/libs/codemirror/mode/htmlmixed/htmlmixed.js;/assets/libs/codemirror/mode/ruby/ruby.js;/assets/libs/codemirror/mode/slim/slim.js",mode_jade:"/assets/libs/codemirror/mode/jade/jade.js","mode_text/css":"","mode_text/x-scss":"","mode_text/x-less":"","mode_text/x-sass":"/assets/libs/codemirror/mode/sass/sass.js",mode_javascript:"",mode_coffeescript:"/assets/libs/codemirror/mode/coffeescript/coffeescript.js",mode_livescript:"/assets/libs/codemirror/mode/livescript/livescript.js",mode_traceur:""},run:function(e,t){if(this.loaded.indexOf(e)>-1)return t();
var s=_.compact(this.files[e].split(";"));return this.loaded.push(e),this.loadJSLibraries(s,t)},loadJSLibraries:function(e,t){if(!(e.length>0))return t();var s=e.shift(),i=this;_getCachedScript(s,function(){i.loadJSLibraries(e,t)})}},TimeUtil={countToString:function(e){var t={1:"first",2:"second",3:"third",4:"fourth",5:"fifth"};return e in t?t[e]:e}},TypesUtil={_HTML_TYPES:["html","xml","haml","markdown","slim","jade","application/x-slim"],_CSS_TYPES:["css","less","scss","sass","stylus","text/css","text/x-sass","text/x-scss","text/x-less"],_JS_TYPES:["js","javascript","coffeescript","livescript","traceur"],cmModeToType:function(e){var t=this._getSafeInputMode(e);return this._getType(t)},_getSafeInputMode:function(e){var t="string"==typeof e?e:e.name;return t.toLowerCase()},syntaxToType:function(e){return this._getType(e)},_getType:function(e){return this._isHTMLType(e)?"html":this._isCSSType(e)?"css":this._isJSType(e)?"js":"unknown"},_isHTMLType:function(e){return _.contains(this._HTML_TYPES,e)},_isCSSType:function(e){return _.contains(this._CSS_TYPES,e)},_isJSType:function(e){return _.contains(this._JS_TYPES,e)}},Follow={init:function(){_.extend(this,AJAXUtil),this.profiled=__profiled,this._bindToDOM()},_bindToDOM:function(){this._addOnHoverChangeToFollowButton(),$("#follow-this-user, #following-this-user")._on("click",this.followThisUser,this)},_addOnHoverChangeToFollowButton:function(){$("#following-this-user").hover(function(){$(this).addClass("red").data("text-value",$(this).html()).html("<svg viewBox='0 0 100 100'><use xlink:href='#icon-x'></use></svg> Following")},function(){$(this).removeClass("red").html($(this).data("text-value"))})},followThisUser:function(){var e=this._getActionTypeTaken();this._updateFollowButtonImmediately(e),this.post(this._getFollowUnfollowURL(e),{},this._doneFollowThisUser)},_getActionTypeTaken:function(){return $("#follow-this-user").is(":visible")?"follow":"unfollow"},_getFollowUnfollowURL:function(e){var t="/follow/<%= type %>/<%= username %>/<%= action %>";return _.template(t,{type:this.profiled.type,username:this.profiled.username,action:e})},_updateFollowButtonImmediately:function(e){"follow"===e?($("#follow-this-user").hide(),$("#following-this-user").show()):($("#follow-this-user").show(),$("#following-this-user").hide())},_doneFollowThisUser:function(e){$("#followers-tab").hasClass("active")&&$("#followers").replaceWith(e.html)}},Drawer={drawer:$("#drawer"),drawerOpen:!1,drawerHasBeenOpened:!1,init:function(){this.bindUIEvents()},bindUIEvents:function(){$("#view-details-button")._on("click",this.toggleDrawer,this),$("#drawer").on("click","#drawer-close-button",this.closeDrawer)},toggleDrawer:function(){Drawer.drawerOpen?Drawer.closeDrawer():Drawer.drawerHasBeenOpened?Drawer.openDrawer():Drawer.setUpDrawer()},openDrawer:function(){Drawer.drawer.show(),setTimeout(function(){Drawer.drawer.addClass("open"),Drawer.drawerOpen=!0,Drawer.drawerHasBeenOpened=!0},10),"function"==typeof Assets.closeAssetsArea&&Assets.closeAssetsArea()},closeDrawer:function(){Drawer.drawer.removeClass("open"),setTimeout(function(){Drawer.drawer.hide(),Drawer.drawerOpen=!1},301)},setUpDrawer:function(){Drawer.drawerHasBeenOpened=!0;var e=window.location.href,t=e.replace("/pen/","/drawer/");$.when($.get(t,function(e){Drawer.drawerContent=e}),$.get("/assets/details/drawer.css",function(e){$("<style></style>").appendTo("head").html(e)}),$.getScript("/assets/details/comment.js")).then(function(){Drawer.drawer.append(Drawer.drawerContent),Drawer.openDrawer(),Comment.init(),Follow.init()})}};Drawer.init();var LiveRoom=Class.extend({WAIT_TO_RUN_FIRST_LIVE_UPDATE:1e3,init:function(e,t){this.rtClient=e,this.rtData=t,_.extend(this,AJAXUtil),this._shouldJoinRoom(t)&&this.rtClient.connect(t,$.proxy(this._onConnect,this),_.noop)},_shouldJoinRoom:function(e){return"editor"===e.role&&e.pen.slugHash},_onConnect:function(){this._subscribeToLocalEvents(),this._subscribeToServerEvents(),this._publishFirstLiveUpdate()},_subscribeToLocalEvents:function(){Hub.sub("live_change",$.proxy(this._publishLiveUpdate,this))},_subscribeToServerEvents:function(){this.rtClient.subscribe("publishToNewClients",this.rtData,$.proxy(this._publishToNewClients,this),!0)},_publishToNewClients:function(){setTimeout($.proxy(function(){this._publishFirstLiveUpdate()},this),this.WAIT_TO_RUN_FIRST_LIVE_UPDATE)},_publishFirstLiveUpdate:function(){this._publishLiveUpdate(null,CP.penRenderer.buildRenderablePen())},_publishLiveUpdate:function(e,t){this.rtClient.publish("liveUpdate",this.rtData,{pen:t})}}),MiniEmbedBuilder={builder:"",overlay:$("#overlay"),builderButton:$(".embed-builder-button"),init:function(){_.extend(this,AJAXUtil),this.bindToDOM()},bindToDOM:function(){this.builderButton._on("click",this.showMiniEmbedBuilder,this),this.overlay._on("click",this.hideBuilder,this)},showMiniEmbedBuilder:function(){this.alreadyLoadedMiniEmbedBuilder()?this.showBuilder():this.getMiniEmbedBuilder()},alreadyLoadedMiniEmbedBuilder:function(){return""!==this.builder},getMiniEmbedBuilder:function(){var e={username:CP.profiled.username,slugHash:CP.pen.slug_hash},t=_.template("/<%= username %>/embed/mini/builder/<%= slugHash %>",e);this.get(t,{},this.doneGetMiniEmbedBuilder)},doneGetMiniEmbedBuilder:function(e){this.addMiniEmbedBuilderAndShow(e),this.addMiniEmbedBuilderCSSAndJS(e)},addMiniEmbedBuilderAndShow:function(e){this.addMiniEmbedBuilderHTMLToPage(e),this.showBuilder(),this.bindToMiniEmbedBuilderDOM()},addMiniEmbedBuilderHTMLToPage:function(e){this.builder=$("<div />",{id:"embed-builder","class":"embed-builder loading",html:e.html}).appendTo("body")},bindToMiniEmbedBuilderDOM:function(){$("#embed-builder-close-button")._on("click",this.hideBuilder,this),Keytrap.bind("esc",$.proxy(this.hideBuilder,this))},addMiniEmbedBuilderCSSAndJS:function(){$.ajax({url:"/assets/embed/embed-builder.css",cache:!1,success:function(e){$("<style></style>").appendTo("head").html(e),$.getScript("/assets/embed/builder/embed_builder.js")}})},showBuilder:function(){this.builder.addClass("open"),this.overlay.show()},hideBuilder:function(){this.builder.removeClass("open loading"),this.overlay.hide()}};MiniEmbedBuilder.init(),$.event.props.push("dataTransfer");var Assets={s:{assetsArea:$("#assets-area"),manualInput:$("#manual-file-upload"),dragPrevent:!1,files:[]},_bindToDragAndDrop:function(){var e,t=this;this.s.assetsArea._on("dragenter dragover",function(s){clearTimeout(e),!t.s.dragPrevent&&t._testIfContainsFiles(s)&&t.makeLookDroppable()}),this.s.assetsArea._on("dragleave dragout",function(){e=setTimeout(function(){t.unmakeLookDroppable()},200)}),this.s.assetsArea._on("drop",function(e){e.preventDefault(),t._testIfContainsFiles(e)&&t.handleFileDrop(e)}),this.s.manualInput._on("change",this.handleFileSelect,this)},_testIfContainsFiles:function(e){return e.dataTransfer.types?_.contains(e.dataTransfer.types,"Files"):!1},makeLookDroppable:function(){this.s.assetsArea.addClass("draggedOn")},unmakeLookDroppable:function(){this.s.assetsArea.removeClass("draggedOn")},handleFileDrop:function(e){this.processFile(e.dataTransfer.files),this.unmakeLookDroppable()},handleFileSelect:function(e){this.processFile(e.target.files)},MAX_FILES:10,MAX_FILE_SIZE:2097152,processFile:function(e){this.numFiles=e.length,this.errors=[],e.length>this.MAX_FILES?this._showTooManyFilesMessage():this._filesTooBig(e)?this._showFileTooBigMessage():this._filesHaveBadFileExtension(e)?this._showBadFileExtensionMessage():AssetsData.anyDuplicates(e)?this._askUserIfTheyWantToOverwriteFiles(e,__assets):this._signAssetsAndUpload(e,__assets,!1)},_askUserIfTheyWantToOverwriteFiles:function(e,t){var s=this;$.showModal("/ajax/assets/overwrite_or_update_assets","modal-error",function(){s._updateFilesToBeOverwrittenModal(e),$("#confirm-overwrite")._on("click",function(){s._onConfirmOverwrite(e,t)}),$("#confirm-create-new")._on("click",function(){s._onConfirmCreateNew(e,t)})})},_updateFilesToBeOverwrittenModal:function(e){var t=AssetsData.duplicateNames(e),s=this._filesToBeOverwrittenHTML(t);$("#list-of-files").html(s)},_filesToBeOverwrittenHTML:function(e){var t="";return _.forEach(e,function(e){t+="<p>"+e+"</p>"}),t},_onConfirmOverwrite:function(e,t){$.hideMessage(),this._signAssetsAndUpload(e,t,!0)},_onConfirmCreateNew:function(e,t){$.hideMessage(),this._signAssetsAndUpload(e,t,!1)},_signAssetsAndUpload:function(e,t,s){for(var i=0;i<this.numFiles;i++){var n=FileUtil.makeNameSafeToSave(e[i].name);if(this.s.files[n]=e[i],s){var o=AssetsData.findAssetByName(e[i].name);e[i].id=o?o.id:0}AssetsSign.signAsset(e[i],$.proxy(this._uploadComplete,this),$.proxy(this._assetUploadFailed,this))}},_filesTooBig:function(e){var t=this;return _.some(e,function(e){return e.size>t.MAX_FILE_SIZE})},_filesHaveBadFileExtension:function(e){return _.some(e,function(e){return e.name.match(/^.+\.(exe)$/)?!0:e.name.match(/^.+\..+$/)?!1:!0})},_showTooManyFilesMessage:function(){$.showModal("/ajax/assets/too_many_files","modal-error")},_showFileTooBigMessage:function(){$.showModal("/ajax/assets/file_too_big","modal-error")},_showBadFileExtensionMessage:function(){$.showModal("/ajax/assets/bad_extension","modal-error")},_assetUploadFailed:function(e){this._decrementFileCount(),this.deleteFileAjax(e.rslt.id);var t=/<Code>(.+)<\/Code>/i.exec(e.responseText)[1];this.errors.push({code:t,file:e.rslt.base_name}),0===this.numFiles&&this.uploadFinalize()},uploadFinalize:function(){if(this.errors.length>0){var e="/ajax/assets/upload_errors?errors="+JSON.stringify(this.errors);$.showModal(e,"modal-error")}},deleteFileAjax:function(e){this.del("/static/assets/"+e,{},this.doneDeleteFileAjax)},_decrementFileCount:function(){--this.numFiles}},AssetsSign={init:function(){_.extend(this,AJAXUtil)},signAsset:function(e,t,s){var i=this._buildParams(e);this.post("/static/sign_asset",i,function(i){AssetsSign.doneSign(i,e,t,s)})},_buildParams:function(e){var t=e.id?e.id:0;return{id:t,contentType:e.type,fileName:FileUtil.makeNameSafeToSave(e.name),fileKB:FileUtil.fileSizeInKb(e),template:this._findTemplate()}},_findTemplate:function(){return"assets_fullpage"===__pageType?"asset_fullpage":"asset"},signProfileNew:function(e,t){for(var s={},i=0;i<e.length;i++)if("string"==typeof e[i].data){var n=AssetsSign.dataURItoBlob(e[i].data),o=Math.round(n.size/1e3);0===o&&(o=1),e[i]={dimension:e[i].dimension,size:o,data:n},s["sizes["+e[i].dimension+"]"]=o}this.post("/static/sign_profile/"+t,s,function(t){AssetsSign.doneSignProfile(t,e)})},doneSignProfile:function(e,t){for(var s=0;s<t.length;s++)AssetsSign.doneSign(e[t[s].dimension],t[s].data,AssetsSign.profileReallyDone)},profileReallyDone:function(){},dataURItoBlob:function(e){for(var t=atob(e.split(",")[1]),s=new ArrayBuffer(t.length),i=new Uint8Array(s),n=0;n<t.length;n++)i[n]=t.charCodeAt(n);return new Blob([s],{type:"image/jpeg"})},doneSign:function(e,t,s,i){var n=AssetsSign.getXHRObject(e,s,i),o=new FormData;for(var r in e.form_data)o.append(r,e.form_data[r]);o.append("file",t),n.open("POST",e.url,!0),n.send(o)},getXHRObject:function(e,t,s){var i=new XMLHttpRequest;return i.rslt=e,"withCredentials"in i||(i=null),i.onreadystatechange=function(){4===i.readyState&&(201===i.status?t(i.rslt):"undefined"!=typeof s&&s(i))},i}};AssetsSign.init(),"undefined"==typeof window.Copy&&(window.Copy={}),_.extend(window.Copy,{assetRenamed:'Asset "<%= name %>" renamed successfully!',assetUploaded:'Asset "<%= name %>" uploaded successfully!'});var Asset=Class.extend({init:function(e){_.extend(this,AJAXUtil),_.extend(this,e)},save:function(e){var t="/static/assets/update/"+this.id,s={content:e};this.post(t,s,this._doneSave)},_doneSave:function(e){Hub.pub("asset-updated",e)},"delete":function(e){var t="/static/assets/"+this.id,s=this;this.del(t,{},function(t){s._doneDelete(t,e)})},_doneDelete:function(e,t){Hub.pub("asset-deleted",e),"function"==typeof t&&t(e)}}),AssetsData={assets:{},selectedAsset:null,boundToHub:!1,init:function(){this._bindToHub(),this._buildAssetObjectsFromDBAssets()},_bindToHub:function(){this.boundToHub||(this.boundToHub=!0,Hub.sub("asset-added",$.proxy(this._onAssetAdded,this)),Hub.sub("asset-deleted",$.proxy(this._onAssetDeleted,this)),Hub.sub("asset-selected",$.proxy(this._onAssetSelected,this)),Hub.sub("asset-deselected",$.proxy(this._onAssetDeselected,this)))},_onAssetAdded:function(e,t){this.add(t.asset)},_onAssetSelected:function(e,t){this.selectedAsset=this.find(t.id)},_onAssetDeleted:function(e,t){this.del(t.id),this.selectedAsset=null},_onAssetDeselected:function(){this.selectedAsset=null},getSelectedAsset:function(){return this.selectedAsset},_buildAssetObjectsFromDBAssets:function(){var e=this;_.forEach(__assets,function(t){e.assets[t.id]=new Asset(t)})},find:function(e){return this.assets[e]},add:function(e){__assets[e.id]=e,this.assets[e.id]=new Asset(e)},del:function(e){delete __assets[e],delete this.assets[e]},anyDuplicates:function(e){return this.duplicateNames(e).length>0},duplicateNames:function(e){var t=this._safeNames(this.assets),s=this._safeNames(e);return _.intersection(t,s)},_safeNames:function(e){return _.map(e,function(e){return FileUtil.makeNameSafeToSave(e.name)})},findAssetByName:function(e){return _.find(this.assets,function(t){return t.name===FileUtil.makeNameSafeToSave(e)})},buildUniqueName:function(e){for(var t=e,s=this.findAssetByName(t);s;)t=this._addUnderscoreOneToExistingName(t),s=this.findAssetByName(t);return t},_addUnderscoreOneToExistingName:function(e){var t=e.split("."),s=t.pop();return t.join(".")+"_copy."+s}},FileUtil={makeNameSafeToSave:function(e){return e.split(" ").join("_")},fileSizeInKb:function(e){var t=Math.round(e.size/1e3);return t=0===t?1:t}},SearchFilter={searchField:$("#assets-search"),init:function(){this._bindToDOM()},_bindToDOM:function(){this.searchField._on("keyup click search",this._onSearchChange,this,!0)},_onSearchChange:function(e,t){$(".single-asset").hide(),$(".single-asset .file-name:contains('"+t.val()+"')").closest(".single-asset").show()}},MinipageAssets={openingLock:!1,assetsWrap:$("#assets-wrap"),allFiles:$("#assets-all-files"),assetsLink:$("#assets-link"),init:function(){this.user=__user,this.pageType="assets_mini",_.extend(this,AJAXUtil),_.extend(this,AssetsSign),_.extend(this,Assets),SearchFilter.init(),this._bindToDOM(),this._bindToHub(),this._bindToDragAndDrop()},_bindToHub:function(){Hub.sub("asset-added",$.proxy(this._onAssetAdded,this))},_bindToDOM:function(){var e=this;this.assetsLink._on("click",this._toggleMiniAssetsView,this),$("#assets-area-close-button")._on("click",this._closeAssetsArea,this),Keytrap.bind("esc",function(){e._closeAssetsArea()}),this.allFiles.on("click",".single-asset",function(t){e._selectAssetInMiniView(t,this)}),this.allFiles.on("mouseleave mouseout",".file-input",this._hideFilePathOnMouseOut),this.allFiles.on("click",".file-delete",function(t){e.deleteFile(t,this)})},_toggleMiniAssetsView:function(){this._isMiniAssetsViewOpen()?this._closeAssetsArea():this._openAssetsArea()},_isMiniAssetsViewOpen:function(){return this.assetsWrap.hasClass("open")},_closeAssetsArea:function(){this.assetsWrap.removeClass("open"),setTimeout(function(){MinipageAssets.assetsWrap.hide()},301)},_openAssetsArea:function(){var e=this;this.openingLock=!0,this._getAssets(),this.assetsWrap.show(),setTimeout(function(){e.assetsWrap.addClass("open")},10),setTimeout(function(){e.openingLock=!1},1e3),"function"==typeof Drawer.closeDrawer&&Drawer.closeDrawer()},_getAssets:function(){this.post("/static/assets",{},this._doneGetAssets)},_doneGetAssets:function(e){window.__assets=e.assets,AssetsData.init(),$("#assets-all-files").html(e.asset_list),$("#progress").replaceWith(e.progress_markup)},_selectAssetInMiniView:function(e,t){e.preventDefault(),this._showFilePath(e,t),this.s.dragPrevent=!0;var s=$(e.target),i=this.user.current_team_id>0?"t-"+this.user.id:this.user.id,n="https://s3-us-west-2.amazonaws.com/s.cdpn.io/"+i+"/"+s.data("file-name");s.val(n)},_showFilePath:function(e,t){var s=$(t).find(".file-input");"none"===s.css("display")?s.show().select():setTimeout(function(){s.select()},40)},_hideFilePathOnMouseOut:function(){var e=this;setTimeout(function(){$(e).hide(),MinipageAssets.s.dragPrevent=!1},300)},deleteFile:function(e,t){e.preventDefault();var s=this,i=$(t).data("asset-id");$.showModal("/ajax/assets/confirm_asset_delete","modal-warning",function(){s._doneConfirmDeleteAsset(i)})},_doneConfirmDeleteAsset:function(e){$("#confirm-delete")._on("click",function(){this.finishDeletingAsset(e)},this)},finishDeletingAsset:function(e){$.hideMessage(),this.deleteFileAjax(e)},_uploadComplete:function(e){this._decrementFileCount(),Hub.pub("asset-added",e)},_onAssetAdded:function(e,t){$("#progress").replaceWith(t.progress_markup),this._addNewAssetHTML(t),this._resetFileInput($("#manual-file-upload"))},_addNewAssetHTML:function(e){var t,s=this;this._assetElExist(e)?$("#asset-"+e.asset.id).slideUp(function(){$("#asset-"+e.asset.id).remove(),t=$(e.markup),t.addClass("newly-added"),s._addAssetToCategory(t,e.asset.category),setTimeout(function(){t.removeClass("newly-added")},50)}):(t=$(e.markup),t.addClass("newly-added"),s._addAssetToCategory(t,e.asset.category),setTimeout(function(){t.removeClass("newly-added")},50))},_assetElExist:function(e){return $("#asset-"+e.asset.id).length>0},_addAssetToCategory:function(e,t){e.prependTo("#file-list-"+t),$("#file-list-"+t).find(".no-files").remove()},_resetFileInput:function(e){e.wrap("<form />").closest("form").get(0).reset(),e.unwrap()},doneDeleteFileAjax:function(e){AssetsData.del(e.id),this._removeListItem(e.id)},_removeListItem:function(e){var t=$("#asset-"+e);0===t.siblings().length&&t.parent().append("<li class='no-files'>There are no files of this type&nbsp;yet.</li>"),t.addClass("deleting").slideUp(250,function(){t.remove()})}};MinipageAssets.init();var TeamRoomNotifications=Class.extend({init:function(e,t){this.rtClient=e,this.rtData=t,this.user=__user,this._debouncedCanCollabOnTeam=_.debounce(this._showCanCollabOnTeamPenMessage,2500),this._shouldJoinRoom(t)&&this.rtClient.connect(t,$.proxy(this._onConnect,this),_.noop)},_shouldJoinRoom:function(e){return"editor"===e.role&&e.pen.slugHash&&this.user.current_team_id>0},_onConnect:function(){this._subscribeToServerEvents(),this._publishCanCollabOnTeamPen()},_subscribeToServerEvents:function(){this.rtClient.subscribe("can-collab-on-team-pen",this.rtData,$.proxy(this._onCanCollabOnTeamPen,this),!0)},_onCanCollabOnTeamPen:function(e){this.user.id!==e.data.user.id&&this._debouncedCanCollabOnTeam(e)},_showCanCollabOnTeamPenMessage:function(e){var t="<%= name %> is also working on this pen. Try Collab Mode with your team member <a href='<%= url %>' target='_blank'>here</a>.",s=document.location.href.replace(/\/pen\//,"/collab/"),i=_.template(t,{name:e.data.user.name,url:s});$.showMessage(i,"slow")},_publishCanCollabOnTeamPen:function(){this.rtClient.publish("can-collab-on-team-pen",this.rtData,{user:this.user})}});CPFactory.buildDataObjects(),CPFactory.buildEditorObjects(),CPFactory.buildDesktopViewEditorObjects(),CP.collections=new Collections,CP.penDelete=new PenDelete,CP.upsell=new Upsell;var rtClient=new RTClient;CP.liveRoom=new LiveRoom(rtClient,_.clone(__rtData)),CP.teamRoomNotifications=new TeamRoomNotifications(rtClient,_.clone(__rtData)),Hub.pub("page-loading-done"),Layout.doneLoading();